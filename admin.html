<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì í˜ì´ì§€</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“„</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.5.0/dist/xlsx.full.min.js"></script>
    <script>
        // xlsx-js-styleì´ ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš° ë™ì  ìŠ¤í¬ë¦½íŠ¸ ë¡œë”©
        if (typeof XLSX === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
            script.async = true;
            document.head.appendChild(script);
        }
    </script>
    <script src="js/api.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'ë§‘ì€ ê³ ë”•', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #440b86;
            text-align: center;
            margin-bottom: 10px;
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .nav-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #440b86;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.3s;
        }

        .nav-link:hover {
            color: #0ca22c;
        }

        .section {
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .section h2 {
            margin-top: 0;
            color: #440b86;
            border-bottom: 2px solid #440b86;
            padding-bottom: 10px;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: #440b86;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0ca22c;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #440b86;
            color: white;
            font-weight: bold;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .stock-low {
            color: #dc3545;
            font-weight: bold;
        }

        .stock-ok {
            color: #28a745;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .form-row .form-group {
            flex: 1;
        }

        .form-row .form-group.narrow {
            max-width: 150px;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 4px;
            display: none;
        }

        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            margin: 0;
            color: #440b86;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            border: 2px solid #440b86;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #440b86;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
            }

            h1 {
                font-size: 24px;
            }

            .header-actions {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .section {
                padding: 15px;
            }

            .section h2 {
                font-size: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .stat-number {
                font-size: 24px;
            }

            table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table thead,
            table tbody {
                display: block;
            }

            table tr {
                display: flex;
                flex-direction: column;
                border: 1px solid #ddd;
                margin-bottom: 10px;
                padding: 10px;
                border-radius: 5px;
                background-color: white;
            }

            table thead tr {
                display: none;
            }

            table td {
                display: flex;
                justify-content: space-between;
                padding: 8px;
                border: none;
                border-bottom: 1px solid #eee;
            }

            table td:last-child {
                border-bottom: none;
            }

            table td:before {
                content: attr(data-label);
                font-weight: bold;
                color: #440b86;
                margin-right: 10px;
            }

            .btn {
                padding: 8px 12px;
                font-size: 14px;
            }

            .btn-small {
                padding: 6px 10px;
                font-size: 12px;
            }

            .modal-content {
                width: 95%;
                margin: 5% auto;
                padding: 20px;
            }

            #stockTable {
                font-size: 14px;
            }

            #stockTable th,
            #stockTable td {
                padding: 8px;
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }

            h1 {
                font-size: 20px;
            }

            .section h2 {
                font-size: 18px;
            }

            .stat-number {
                font-size: 20px;
            }

            .btn {
                width: 100%;
                margin-bottom: 5px;
            }

            .header-actions {
                width: 100%;
            }

            .header-actions > div,
            .header-actions button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-actions">
            <div>
                <a href="requestbrochure.html" class="nav-link">â† ì‹ ì²­ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</a>
            </div>
            <button class="btn btn-secondary" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
        
        <h1>ê´€ë¦¬ì í˜ì´ì§€</h1>
        <div id="alert" class="alert"></div>

        <!-- ì¬ê³  í˜„í™© ëŒ€ì‹œë³´ë“œ -->
        <div class="section">
            <h2>ì¬ê³  í˜„í™©</h2>
            <div class="stats-grid" id="statsGrid">
                <!-- í†µê³„ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
            
            <!-- í’ˆëª©ë³„ ì¬ê³  í˜„í™© -->
            <div style="margin-top: 30px;">
                <h3 style="margin-bottom: 15px;">í’ˆëª©ë³„ ì¬ê³  í˜„í™©</h3>
                <table id="stockTable" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: #440b86; color: white;">
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">ë¸Œë¡œì…”ëª…</th>
                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">ì¬ê³  ìˆ˜ëŸ‰</th>
                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">ìƒíƒœ</th>
                        </tr>
                    </thead>
                    <tbody id="stockTableBody">
                        <!-- í’ˆëª©ë³„ ì¬ê³ ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ë¸Œë¡œì…” ê´€ë¦¬ -->
        <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0;">ë¸Œë¡œì…” ê´€ë¦¬</h2>
                <button class="btn btn-primary" onclick="downloadStockHistory()">ì…ì¶œê³  ë‚´ì—­ ë‹¤ìš´ë¡œë“œ</button>
            </div>
            <button class="btn btn-success" onclick="openBrochureModal()">+ ë¸Œë¡œì…” ì¶”ê°€</button>
            <table id="brochureTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ë¸Œë¡œì…”ëª…</th>
                        <th>í˜„ì¬ ì¬ê³ </th>
                        <th>ë§ˆì§€ë§‰ ì…ê³  ìˆ˜ëŸ‰</th>
                        <th>ì…ê³ </th>
                        <th>ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="brochureTableBody">
                    <!-- ë¸Œë¡œì…” ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </tbody>
            </table>
        </div>

        <!-- ë‹´ë‹¹ì ê´€ë¦¬ -->
        <div class="section">
            <h2>ë‹´ë‹¹ì ê´€ë¦¬</h2>
            <button class="btn btn-success" onclick="openContactModal()">+ ë‹´ë‹¹ì ì¶”ê°€</button>
            <table id="contactTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ë‹´ë‹¹ìëª…</th>
                        <th>ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="contactTableBody">
                    <!-- ë‹´ë‹¹ì ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </tbody>
            </table>
        </div>

        <!-- ê´€ë¦¬ì ê³„ì • ê´€ë¦¬ -->
        <div class="section">
            <h2>ê´€ë¦¬ì ê³„ì • ê´€ë¦¬</h2>
            
            <!-- ê³„ì • ëª©ë¡ -->
            <div style="margin-bottom: 20px;">
                <h3>ê³„ì • ëª©ë¡</h3>
                <table id="adminUsersTable" style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <thead>
                        <tr style="background-color: #440b86; color: white;">
                            <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">ID</th>
                            <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">ì‚¬ìš©ìëª…</th>
                            <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">ìƒì„±ì¼</th>
                            <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody id="adminUsersTableBody">
                        <!-- ê³„ì • ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>
            
            <!-- ê³„ì • ì¶”ê°€ -->
            <div style="margin-bottom: 20px; padding: 15px; background-color: white; border-radius: 5px; border: 1px solid #ddd;">
                <h3>ìƒˆ ê³„ì • ì¶”ê°€</h3>
                <form id="addAdminForm" style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ì‚¬ìš©ìëª…</label>
                        <input type="text" id="newUsername" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="newPassword" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                        <button type="submit" class="btn btn-primary">ê³„ì • ì¶”ê°€</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ë¸Œë¡œì…” ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="brochureModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="brochureModalTitle">ë¸Œë¡œì…” ì¶”ê°€</h3>
                <span class="close" onclick="closeBrochureModal()">&times;</span>
            </div>
            <form id="brochureForm">
                <input type="hidden" id="brochureId" value="">
                <div class="form-group">
                    <label for="brochureName">ë¸Œë¡œì…”ëª…</label>
                    <input type="text" id="brochureName" required>
                </div>
                <div class="form-group" id="stockGroup" style="display: none;">
                    <label for="brochureStock">ì´ˆê¸° ì¬ê³ </label>
                    <input type="number" id="brochureStock" min="0" value="0">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeBrochureModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ë‹´ë‹¹ì ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="contactModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="contactModalTitle">ë‹´ë‹¹ì ì¶”ê°€</h3>
                <span class="close" onclick="closeContactModal()">&times;</span>
            </div>
            <form id="contactForm">
                <input type="hidden" id="contactId" value="">
                <div class="form-group">
                    <label for="contactName">ë‹´ë‹¹ìëª…</label>
                    <input type="text" id="contactName" required>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeContactModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
                <span class="close" onclick="closePasswordModal()">&times;</span>
            </div>
            <form id="changePasswordForm">
                <input type="hidden" id="changePasswordUserId">
                <div class="form-group">
                    <label for="currentPassword">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="currentPassword" required>
                </div>
                <div class="form-group">
                    <label for="newPasswordInput">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="newPasswordInput" required>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                    <input type="password" id="confirmPassword" required>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closePasswordModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ë³€ê²½</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ì…ê³  ì²˜ë¦¬ ëª¨ë‹¬ -->
    <div id="stockModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ì…ê³  ì²˜ë¦¬</h3>
                <span class="close" onclick="closeStockModal()">&times;</span>
            </div>
            <form id="stockForm">
                <input type="hidden" id="stockBrochureId" value="">
                <div class="form-group">
                    <label id="stockBrochureName">ë¸Œë¡œì…”ëª…</label>
                </div>
                <div class="form-group">
                    <label for="stockDate">ì…ê³  ë‚ ì§œ</label>
                    <input type="date" id="stockDate" required>
                </div>
                <div class="form-group">
                    <label for="stockQuantity">ì…ê³  ìˆ˜ëŸ‰</label>
                    <input type="number" id="stockQuantity" min="1" required>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeStockModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ì…ê³  ì²˜ë¦¬</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ì¬ê³  ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="stockEditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ì¬ê³  ìˆ˜ì •</h3>
                <span class="close" onclick="closeStockEditModal()">&times;</span>
            </div>
            <form id="stockEditForm">
                <input type="hidden" id="stockEditBrochureId" value="">
                <div class="form-group">
                    <label id="stockEditBrochureName">ë¸Œë¡œì…”ëª…</label>
                </div>
                <div class="form-group">
                    <label for="stockEditQuantity">ì¬ê³  ìˆ˜ëŸ‰</label>
                    <input type="number" id="stockEditQuantity" min="0" required>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeStockEditModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ìˆ˜ì •</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ë¡œê·¸ì¸ ì²´í¬
        function checkLogin() {
            const isLoggedIn = sessionStorage.getItem('admin_logged_in');
            if (!isLoggedIn || isLoggedIn !== 'true') {
                window.location.href = 'admin-login.html';
                return false;
            }
            return true;
        }

        // ì´ˆê¸° ë°ì´í„° ì„¤ì • (ë” ì´ìƒ í•„ìš” ì—†ìŒ - ë°±ì—”ë“œì—ì„œ ì²˜ë¦¬)
        async function initializeData() {
            // ë°±ì—”ë“œì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ë¯€ë¡œ ì´ˆê¸°í™” ë¶ˆí•„ìš”
        }

        // ì•Œë¦¼ í‘œì‹œ
        function showAlert(message, type = 'success') {
            const alertDiv = document.getElementById('alert');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 3000);
        }

        // ë¸Œë¡œì…” ëª©ë¡ ë¡œë“œ ë° í‘œì‹œ
        async function loadBrochures() {
            try {
                const brochures = await BrochureAPI.getAll();
                const tbody = document.getElementById('brochureTableBody');
                tbody.innerHTML = '';

                brochures.forEach(brochure => {
                    const row = document.createElement('tr');
                    const stockClass = (brochure.stock || 0) < 10 ? 'stock-low' : 'stock-ok';
                    const lastStockQuantity = brochure.last_stock_quantity || 0;
                    const lastStockDate = brochure.last_stock_date || '-';
                    row.innerHTML = `
                        <td data-label="ID">${brochure.id}</td>
                        <td data-label="ë¸Œë¡œì…”ëª…">${brochure.name}</td>
                        <td data-label="í˜„ì¬ ì¬ê³ " class="${stockClass}">${brochure.stock || 0}ê¶Œ</td>
                        <td data-label="ë§ˆì§€ë§‰ ì…ê³ ">${lastStockQuantity > 0 ? `${lastStockQuantity}ê¶Œ (${lastStockDate})` : '-'}</td>
                        <td data-label="ì…ê³ ">
                            <button class="btn btn-success btn-small" onclick="openStockModal('${brochure.id}')">ì…ê³ </button>
                        </td>
                        <td data-label="ì‘ì—…">
                            <button class="btn btn-primary btn-small" onclick="editBrochure('${brochure.id}')">ìˆ˜ì •</button>
                            <button class="btn btn-secondary btn-small" onclick="openStockEditModal('${brochure.id}')">ì¬ê³  ìˆ˜ì •</button>
                            <button class="btn btn-danger btn-small" onclick="deleteBrochure('${brochure.id}')">ì‚­ì œ</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                updateStats(brochures);
            } catch (error) {
                console.error('ë¸Œë¡œì…” ë¡œë“œ ì˜¤ë¥˜:', error);
                showAlert('ë¸Œë¡œì…” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
            }
        }

        // ë‹´ë‹¹ì ëª©ë¡ ë¡œë“œ ë° í‘œì‹œ
        async function loadContacts() {
            try {
                const contacts = await ContactAPI.getAll();
                const tbody = document.getElementById('contactTableBody');
                tbody.innerHTML = '';

                contacts.forEach(contact => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td data-label="ID">${contact.id}</td>
                        <td data-label="ë‹´ë‹¹ìëª…">${contact.name}</td>
                        <td data-label="ì‘ì—…">
                            <button class="btn btn-primary btn-small" onclick="editContact('${contact.id}')">ìˆ˜ì •</button>
                            <button class="btn btn-danger btn-small" onclick="deleteContact('${contact.id}')">ì‚­ì œ</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('ë‹´ë‹¹ì ë¡œë“œ ì˜¤ë¥˜:', error);
                showAlert('ë‹´ë‹¹ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
            }
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats(brochures = []) {
            const totalStock = brochures.reduce((sum, b) => sum + (b.stock || 0), 0);
            // ì¬ê³  ë¶€ì¡± ê¸°ì¤€: 400ê¶Œ ì´í•˜
            const lowStockCount = brochures.filter(b => (b.stock || 0) <= 400).length;
            const totalBrochures = brochures.length;

            const statsGrid = document.getElementById('statsGrid');
            if (!statsGrid) {
                console.error('statsGrid element not found');
                return;
            }

            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${totalBrochures}</div>
                    <div class="stat-label">ì´ ë¸Œë¡œì…” ì¢…ë¥˜</div>
                </div>
                <!-- <div class="stat-card">
                    <div class="stat-number">${totalStock}</div>
                    <div class="stat-label">ì´ ì¬ê³  ìˆ˜ëŸ‰</div>
                </div> -->
                <div class="stat-card">
                    <div class="stat-number" style="color: ${lowStockCount > 0 ? '#dc3545' : '#28a745'}">${lowStockCount}</div>
                    <div class="stat-label">ì¬ê³  ë¶€ì¡± í•­ëª©</div>
                </div>
            `;

            // í’ˆëª©ë³„ ì¬ê³  í˜„í™© ì—…ë°ì´íŠ¸
            updateStockTable();
        }

        // í’ˆëª©ë³„ ì¬ê³  í˜„í™© í…Œì´ë¸” ì—…ë°ì´íŠ¸
        async function updateStockTable() {
            try {
                const brochures = await BrochureAPI.getAll();
                const tbody = document.getElementById('stockTableBody');
                tbody.innerHTML = '';

            if (brochures.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" style="padding: 20px; text-align: center; color: #666;">
                            ë“±ë¡ëœ ë¸Œë¡œì…”ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                `;
                return;
            }

            // ì¬ê³  ìˆ˜ëŸ‰ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ (ë†’ì€ ìˆœ)
            const sortedBrochures = [...brochures].sort((a, b) => (b.stock || 0) - (a.stock || 0));

            sortedBrochures.forEach(brochure => {
                const stock = brochure.stock || 0;
                const stockClass = stock <= 400 ? 'stock-low' : 'stock-ok';
                // ì¬ê³  ìƒíƒœ: 400 ì´í•˜=ì¬ê³  ë¶€ì¡±, 400~800=ë³´í†µ, 800 ì´ìƒ=ì¶©ë¶„
                const statusText = stock <= 400 ? 'ì¬ê³  ë¶€ì¡±' : stock < 800 ? 'ë³´í†µ' : 'ì¶©ë¶„';
                const statusColor = stock <= 400 ? '#dc3545' : stock < 800 ? '#ffc107' : '#28a745';
                
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #ddd';
                row.innerHTML = `
                    <td data-label="ë¸Œë¡œì…”ëª…" style="padding: 12px; border: 1px solid #ddd;">${brochure.name}</td>
                    <td data-label="ì¬ê³  ìˆ˜ëŸ‰" style="padding: 12px; text-align: center; border: 1px solid #ddd; font-weight: bold; color: ${stock < 200 ? '#dc3545' : '#333'}">${stock}ê¶Œ</td>
                    <td data-label="ìƒíƒœ" style="padding: 12px; text-align: center; border: 1px solid #ddd;">
                        <span style="color: ${statusColor}; font-weight: bold;">${statusText}</span>
                    </td>
                `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('ì¬ê³  í˜„í™© ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            }
        }

        // ë¸Œë¡œì…” ëª¨ë‹¬ ì—´ê¸°
        async function openBrochureModal(id = null) {
            const modal = document.getElementById('brochureModal');
            const form = document.getElementById('brochureForm');
            const title = document.getElementById('brochureModalTitle');
            const stockGroup = document.getElementById('stockGroup');

            if (id) {
                // ìˆ˜ì • ëª¨ë“œ
                try {
                    const brochures = await BrochureAPI.getAll();
                    const brochure = brochures.find(b => b.id == id);
                    if (brochure) {
                        document.getElementById('brochureId').value = brochure.id;
                        document.getElementById('brochureName').value = brochure.name;
                        title.textContent = 'ë¸Œë¡œì…” ìˆ˜ì •';
                        stockGroup.style.display = 'none';
                    }
                } catch (error) {
                    showAlert('ë¸Œë¡œì…” ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
                    return;
                }
            } else {
                // ì¶”ê°€ ëª¨ë“œ
                form.reset();
                document.getElementById('brochureId').value = '';
                title.textContent = 'ë¸Œë¡œì…” ì¶”ê°€';
                stockGroup.style.display = 'block';
            }
            modal.style.display = 'block';
        }

        // ë¸Œë¡œì…” ëª¨ë‹¬ ë‹«ê¸°
        function closeBrochureModal() {
            document.getElementById('brochureModal').style.display = 'none';
            document.getElementById('brochureForm').reset();
        }

        // ë¸Œë¡œì…” ì €ì¥
        document.getElementById('brochureForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = document.getElementById('brochureId').value;
            const name = document.getElementById('brochureName').value;
            const initialStock = parseInt(document.getElementById('brochureStock').value) || 0;

            try {
                if (id) {
                    // ìˆ˜ì •
                    await BrochureAPI.update(id, { name, stock: initialStock });
                    showAlert('ë¸Œë¡œì…”ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    // ì¶”ê°€
                    await BrochureAPI.create({ name, stock: initialStock });
                    showAlert('ë¸Œë¡œì…”ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
                
                await loadBrochures();
                closeBrochureModal();
            } catch (error) {
                showAlert('ë¸Œë¡œì…” ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'danger');
            }
        });

        // ë¸Œë¡œì…” ìˆ˜ì •
        async function editBrochure(id) {
            try {
                const brochures = await BrochureAPI.getAll();
                const brochure = brochures.find(b => b.id == id);
                if (brochure) {
                    openBrochureModal(id);
                }
            } catch (error) {
                showAlert('ë¸Œë¡œì…” ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
            }
        }

        // ë¸Œë¡œì…” ì‚­ì œ
        async function deleteBrochure(id) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                await BrochureAPI.delete(id);
                await loadBrochures();
                showAlert('ë¸Œë¡œì…”ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                showAlert('ë¸Œë¡œì…” ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'danger');
            }
        }

        // ì…ê³  ì²˜ë¦¬ ëª¨ë‹¬ ì—´ê¸°
        async function openStockModal(id) {
            try {
                const brochures = await BrochureAPI.getAll();
                const brochure = brochures.find(b => b.id == id);
                
                if (brochure) {
                    const modal = document.getElementById('stockModal');
                    document.getElementById('stockBrochureId').value = id;
                    document.getElementById('stockBrochureName').textContent = `ë¸Œë¡œì…”ëª…: ${brochure.name}`;
                    document.getElementById('stockDate').value = new Date().toISOString().split('T')[0];
                    document.getElementById('stockQuantity').value = 1;
                    modal.style.display = 'block';
                }
            } catch (error) {
                showAlert('ë¸Œë¡œì…” ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
            }
        }

        // ì…ê³  ì²˜ë¦¬ ëª¨ë‹¬ ë‹«ê¸°
        function closeStockModal() {
            document.getElementById('stockModal').style.display = 'none';
            document.getElementById('stockForm').reset();
        }

        // ì…ê³  ì²˜ë¦¬
        document.getElementById('stockForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = document.getElementById('stockBrochureId').value;
            const quantity = parseInt(document.getElementById('stockQuantity').value) || 0;
            const date = document.getElementById('stockDate').value;

            if (quantity <= 0) {
                showAlert('ì…ê³  ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'danger');
                return;
            }

            if (!date) {
                showAlert('ì…ê³  ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'danger');
                return;
            }

            try {
                // í˜„ì¬ ì¬ê³  ì¡°íšŒ
                const brochures = await BrochureAPI.getAll();
                const brochure = brochures.find(b => b.id == id);
                
                if (!brochure) {
                    showAlert('ë¸Œë¡œì…”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'danger');
                    return;
                }
                
                const beforeStock = brochure.stock || 0;
                
                // ì¬ê³  ì—…ë°ì´íŠ¸
                await BrochureAPI.updateStock(id, quantity, date);
                
                // ì…ê³  ë‚´ì—­ ì €ì¥
                await StockHistoryAPI.create({
                    type: 'ì…ê³ ',
                    date: date,
                    brochure_id: id,
                    brochure_name: brochure.name,
                    quantity: quantity,
                    contact_name: 'ê´€ë¦¬ì',
                    before_stock: beforeStock,
                    after_stock: beforeStock + quantity
                });
                
                await loadBrochures();
                showAlert(`${quantity}ê¶Œì´ ì…ê³ ë˜ì—ˆìŠµë‹ˆë‹¤. (ì…ê³ ì¼: ${date})`);
                closeStockModal();
            } catch (error) {
                showAlert('ì…ê³  ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'danger');
            }
        });

        // ì¬ê³  ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
        async function openStockEditModal(id) {
            try {
                const brochures = await BrochureAPI.getAll();
                const brochure = brochures.find(b => b.id == id);
                
                if (brochure) {
                    const modal = document.getElementById('stockEditModal');
                    document.getElementById('stockEditBrochureId').value = id;
                    document.getElementById('stockEditBrochureName').textContent = `ë¸Œë¡œì…”ëª…: ${brochure.name}`;
                    document.getElementById('stockEditQuantity').value = brochure.stock || 0;
                    modal.style.display = 'block';
                }
            } catch (error) {
                showAlert('ë¸Œë¡œì…” ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
            }
        }

        // ì¬ê³  ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°
        function closeStockEditModal() {
            document.getElementById('stockEditModal').style.display = 'none';
            document.getElementById('stockEditForm').reset();
        }

        // ì¬ê³  ìˆ˜ì •
        document.getElementById('stockEditForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = document.getElementById('stockEditBrochureId').value;
            const newQuantity = parseInt(document.getElementById('stockEditQuantity').value) || 0;

            if (newQuantity < 0) {
                showAlert('ì¬ê³  ìˆ˜ëŸ‰ì€ 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'danger');
                return;
            }

            try {
                // í˜„ì¬ ë¸Œë¡œì…” ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const brochures = await BrochureAPI.getAll();
                const brochure = brochures.find(b => b.id == id);
                
                if (!brochure) {
                    showAlert('ë¸Œë¡œì…”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'danger');
                    return;
                }

                // í˜„ì¬ ì¬ê³ ì™€ ìƒˆ ì¬ê³ ì˜ ì°¨ì´ ê³„ì‚°
                const quantityDifference = newQuantity - brochure.stock;
                
                // ì¬ê³  ì°¨ì´ë¥¼ ì‚¬ìš©í•˜ì—¬ ì—…ë°ì´íŠ¸ (ì…ê³ /ì¶œê³  ë°©ì‹)
                await BrochureAPI.updateStock(id, quantityDifference, new Date().toISOString().split('T')[0]);
                await loadBrochures();
                showAlert('ì¬ê³ ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeStockEditModal();
            } catch (error) {
                showAlert('ì¬ê³  ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'danger');
            }
        });

        // ë‹´ë‹¹ì ëª¨ë‹¬ ì—´ê¸°
        async function openContactModal(id = null) {
            const modal = document.getElementById('contactModal');
            const form = document.getElementById('contactForm');
            const title = document.getElementById('contactModalTitle');

            if (id) {
                // ìˆ˜ì • ëª¨ë“œ
                try {
                    const contacts = await ContactAPI.getAll();
                    const contact = contacts.find(c => c.id == id);
                    if (contact) {
                        document.getElementById('contactId').value = contact.id;
                        document.getElementById('contactName').value = contact.name;
                        title.textContent = 'ë‹´ë‹¹ì ìˆ˜ì •';
                    }
                } catch (error) {
                    showAlert('ë‹´ë‹¹ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
                    return;
                }
            } else {
                // ì¶”ê°€ ëª¨ë“œ
                form.reset();
                document.getElementById('contactId').value = '';
                title.textContent = 'ë‹´ë‹¹ì ì¶”ê°€';
            }
            modal.style.display = 'block';
        }

        // ë‹´ë‹¹ì ëª¨ë‹¬ ë‹«ê¸°
        function closeContactModal() {
            document.getElementById('contactModal').style.display = 'none';
            document.getElementById('contactForm').reset();
        }

        // ë‹´ë‹¹ì ì €ì¥
        document.getElementById('contactForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = document.getElementById('contactId').value;
            const name = document.getElementById('contactName').value;

            try {
                if (id) {
                    // ìˆ˜ì •
                    await ContactAPI.update(id, { name });
                    showAlert('ë‹´ë‹¹ìê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    // ì¶”ê°€
                    await ContactAPI.create({ name });
                    showAlert('ë‹´ë‹¹ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
                
                await loadContacts();
                closeContactModal();
            } catch (error) {
                showAlert('ë‹´ë‹¹ì ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'danger');
            }
        });

        // ë‹´ë‹¹ì ìˆ˜ì •
        function editContact(id) {
            openContactModal(id);
        }

        // ë‹´ë‹¹ì ì‚­ì œ
        async function deleteContact(id) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                await ContactAPI.delete(id);
                await loadContacts();
                showAlert('ë‹´ë‹¹ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                showAlert('ë‹´ë‹¹ì ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'danger');
            }
        }

        // ì…ì¶œê³  ë‚´ì—­ ì €ì¥ í•¨ìˆ˜
        async function recordStockTransaction(transaction) {
            try {
                await StockHistoryAPI.create({
                    type: transaction.type,
                    date: transaction.date,
                    brochure_id: transaction.brochureId,
                    brochure_name: transaction.brochureName,
                    quantity: transaction.quantity,
                    contact_name: transaction.contactName || '',
                    schoolname: transaction.schoolname || '',
                    before_stock: transaction.beforeStock,
                    after_stock: transaction.afterStock
                });
            } catch (error) {
                console.error('ì…ì¶œê³  ë‚´ì—­ ì €ì¥ ì˜¤ë¥˜:', error);
            }
        }

        // ì…ì¶œê³  ë‚´ì—­ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
        async function downloadStockHistory() {
            try {
                const history = await StockHistoryAPI.getAll();
                
                if (history.length === 0) {
                    showAlert('ë‹¤ìš´ë¡œë“œí•  ì…ì¶œê³  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.', 'danger');
                    return;
                }

            // ì—‘ì…€ ë°ì´í„° ìƒì„±
            const excelData = [];
            
            // í—¤ë” í–‰
            excelData.push([
                'êµ¬ë¶„',
                'ë‚ ì§œ',
                'ë¸Œë¡œì…”ëª…',
                'ìˆ˜ëŸ‰',
                'ë‹´ë‹¹ì',
                'ê¸°ê´€ëª…',
                'ì´ì „ ì¬ê³ ',
                'ì´í›„ ì¬ê³ ',
                'ì²˜ë¦¬ ì‹œê°„'
            ]);

                // ë°ì´í„° í–‰
                history.forEach(item => {
                    excelData.push([
                        item.type || '',
                        item.date || '',
                        item.brochure_name || '',
                        item.quantity || 0,
                        item.contact_name || '',
                        item.schoolname || '',
                        item.before_stock || 0,
                        item.after_stock || 0,
                        item.created_at ? new Date(item.created_at).toLocaleString('ko-KR') : ''
                    ]);
                });

            // ì›Œí¬ë¶ ìƒì„±
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(excelData);

            // í—¤ë” ìŠ¤íƒ€ì¼ ì ìš©
            if (XLSX.utils.sheet_add_aoa) {
                const headerRange = XLSX.utils.decode_range(ws['!ref']);
                for (let col = headerRange.s.c; col <= headerRange.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                    if (!ws[cellAddress]) continue;
                    
                    ws[cellAddress].s = {
                        font: { bold: true },
                        fill: { fgColor: { rgb: "D3D3D3" } },
                        alignment: { horizontal: "center", vertical: "center" }
                    };
                }
            }

            // ì—´ ë„ˆë¹„ ì„¤ì •
            ws['!cols'] = [
                { wch: 10 }, // êµ¬ë¶„
                { wch: 12 }, // ë‚ ì§œ
                { wch: 30 }, // ë¸Œë¡œì…”ëª…
                { wch: 10 }, // ìˆ˜ëŸ‰
                { wch: 15 }, // ë‹´ë‹¹ì
                { wch: 20 }, // ê¸°ê´€ëª…
                { wch: 12 }, // ì´ì „ ì¬ê³ 
                { wch: 12 }, // ì´í›„ ì¬ê³ 
                { wch: 20 }  // ì²˜ë¦¬ ì‹œê°„
            ];

            XLSX.utils.book_append_sheet(wb, ws, 'ì…ì¶œê³  ë‚´ì—­');

            // íŒŒì¼ëª… ìƒì„± (í˜„ì¬ ë‚ ì§œ í¬í•¨)
            const today = new Date();
            const dateStr = today.getFullYear() + 
                          String(today.getMonth() + 1).padStart(2, '0') + 
                          String(today.getDate()).padStart(2, '0');
            const fileName = `ì…ì¶œê³ ë‚´ì—­_${dateStr}.xlsx`;

                // ë‹¤ìš´ë¡œë“œ
                XLSX.writeFile(wb, fileName);
                showAlert('ì…ì¶œê³  ë‚´ì—­ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (error) {
                showAlert('ì…ì¶œê³  ë‚´ì—­ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'danger');
            }
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            sessionStorage.removeItem('admin_logged_in');
            sessionStorage.removeItem('admin_username');
            window.location.href = 'admin-login.html';
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            const brochureModal = document.getElementById('brochureModal');
            const contactModal = document.getElementById('contactModal');
            const stockModal = document.getElementById('stockModal');
            const stockEditModal = document.getElementById('stockEditModal');
            const passwordModal = document.getElementById('passwordModal');
            
            if (event.target === brochureModal) {
                closeBrochureModal();
            }
            if (event.target === contactModal) {
                closeContactModal();
            }
            if (event.target === stockModal) {
                closeStockModal();
            }
            if (event.target === stockEditModal) {
                closeStockEditModal();
            }
            if (event.target === passwordModal) {
                closePasswordModal();
            }
        }

        // ê´€ë¦¬ì ê³„ì • ëª©ë¡ ë¡œë“œ
        async function loadAdminUsers() {
            try {
                const users = await AdminAPI.getAllUsers();
                const tbody = document.getElementById('adminUsersTableBody');
                tbody.innerHTML = '';
                
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="padding: 10px; border: 1px solid #ddd;">${user.id}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${user.username}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${new Date(user.created_at).toLocaleDateString('ko-KR')}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">
                            <button class="btn btn-primary" onclick="openPasswordModal(${user.id})" style="margin-right: 5px;">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                            <button class="btn btn-danger" onclick="deleteAdminUser(${user.id})" ${users.length <= 1 ? 'disabled' : ''}>ì‚­ì œ</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('ê´€ë¦¬ì ê³„ì • ë¡œë“œ ì˜¤ë¥˜:', error);
                showAlert('ê´€ë¦¬ì ê³„ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
            }
        }

        // ê³„ì • ì¶”ê°€
        document.getElementById('addAdminForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            
            try {
                const result = await AdminAPI.createUser(username, password);
                if (result.success) {
                    showAlert('ê³„ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    document.getElementById('addAdminForm').reset();
                    await loadAdminUsers();
                } else {
                    showAlert(result.error || 'ê³„ì • ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
                }
            } catch (error) {
                showAlert('ê³„ì • ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'danger');
            }
        });

        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ ì—´ê¸°
        function openPasswordModal(userId) {
            document.getElementById('changePasswordUserId').value = userId;
            document.getElementById('passwordModal').style.display = 'block';
        }

        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ ë‹«ê¸°
        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('changePasswordForm').reset();
        }

        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
        document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const userId = document.getElementById('changePasswordUserId').value;
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPasswordInput').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                showAlert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'danger');
                return;
            }
            
            try {
                const result = await AdminAPI.changePassword(userId, currentPassword, newPassword);
                if (result.success) {
                    showAlert('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    closePasswordModal();
                } else {
                    showAlert(result.error || 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
                }
            } catch (error) {
                showAlert('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'danger');
            }
        });

        // ê´€ë¦¬ì ê³„ì • ì‚­ì œ
        async function deleteAdminUser(userId) {
            if (!confirm('ì •ë§ ì´ ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                const result = await AdminAPI.deleteUser(userId);
                if (result.success) {
                    showAlert('ê³„ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    await loadAdminUsers();
                } else {
                    showAlert(result.error || 'ê³„ì • ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
                }
            } catch (error) {
                showAlert('ê³„ì • ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'danger');
            }
        }


        // í˜ì´ì§€ ë¡œë“œ ì‹œ
        window.addEventListener('DOMContentLoaded', async function() {
            if (!checkLogin()) return;
            
            await initializeData();
            await loadBrochures();
            await loadContacts();
            await loadAdminUsers();
        });
    </script>
</body>
</html>

