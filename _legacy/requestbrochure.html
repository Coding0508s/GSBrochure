<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Request Brochure</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'ë§‘ì€ ê³ ë”•', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #440b86;
            text-align: center;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .form-section h3 {
            margin-top: 0;
            color: #440b86;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group.expand {
            flex: 1;
        }

        .form-group.narrow {
            max-width: 300px;
            width: 300px;
            flex-shrink: 0;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .row-container {
            border: 2px solid #440b86;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: white;
            position: relative;
        }

        .row-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        .row-number {
            font-weight: bold;
            color: #440b86;
            font-size: 16px;
        }

        .schoolname-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            color: #440b86;
        }

        .schoolname-input::placeholder {
            color: #999;
            font-weight: normal;
        }

        .row-fields {
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }

        .row-fields.full-width {
            flex-direction: column;
        }

        .row-fields.full-width .form-group {
            width: 100%;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: #440b86;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0ca22c;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn-add-row {
            width: 100%;
            margin-top: 10px;
        }

        .invoice-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: flex-end;
            margin-bottom: 10px;
        }

        .invoice-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .invoice-group input {
            width: 150px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .invoice-group .btn {
            flex-shrink: 0;
        }

        .invoice-add-btn {
            margin-top: 0;
        }

        .brochure-container {
            margin-bottom: 15px;
            width: 100%;
        }

        .brochure-item {
            margin-bottom: 15px;
            width: 100%;
        }

        .brochure-item-header {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 5px;
        }

        .brochure-item-header .form-group {
            margin-bottom: 0;
        }

        .brochure-item-header .form-group.expand {
            flex: 1;
        }

        .brochure-item-header .form-group.narrow {
            max-width: 300px;
            flex-shrink: 0;
            width: 300px;
        }

        .brochure-item-fields {
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }

        .brochure-item-fields .form-group {
            margin-bottom: 15px;
        }

        .brochure-item-fields .form-group.expand {
            flex: 1;
        }

        .brochure-item-fields .form-group.narrow {
            max-width: 300px;
            flex-shrink: 0;
            width: 300px;
        }

        .brochure-add-btn {
            margin-top: 0;
        }

        .btn-submit {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            margin-top: 20px;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 4px;
            display: none;
        }

        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .nav-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #440b86;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.3s;
        }

        .nav-link:hover {
            color: #0ca22c;
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
            }

            h1 {
                font-size: 24px;
            }

            .subtitle {
                font-size: 14px;
            }

            .row-header {
                flex-direction: column;
                gap: 10px;
            }

            .row-fields {
                flex-direction: column;
                gap: 10px;
            }

            .form-group.narrow {
                max-width: 100%;
                width: 100%;
            }

            .form-group.expand {
                width: 100%;
            }

            .brochure-item-header {
                flex-direction: column;
                gap: 10px;
            }

            .brochure-item-header .form-group.narrow {
                max-width: 100%;
                width: 100%;
            }

            .brochure-item-fields {
                flex-direction: column;
                gap: 10px;
            }

            .brochure-item-fields .form-group.narrow {
                max-width: 100%;
                width: 100%;
            }

            .invoice-group {
                flex-direction: column;
                gap: 10px;
            }

            .invoice-group input {
                width: 100%;
            }

            .btn {
                width: 100%;
                margin-bottom: 5px;
            }

            .btn-add-row {
                width: 100%;
            }

            .row-container {
                padding: 10px;
            }
        }

        @media screen and (max-width: 480px) {
            .container {
                padding: 10px;
            }

            h1 {
                font-size: 20px;
            }

            .form-section {
                padding: 15px;
            }

            .row-container {
                padding: 8px;
            }

            input, select {
                font-size: 16px; /* iOS ì¤Œ ë°©ì§€ */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="requestbrochure-list.html" class="nav-link">ğŸ“‹ ì‹ ì²­ ë‚´ì—­ ì¡°íšŒ</a>
        <a href="requestbrochure logistics.html" class="nav-link">ğŸ“‹ ìš´ì†¡ì¥ ë²ˆí˜¸ ì…ë ¥</a>
        <a href="admin-login.html" class="nav-link">âš™ï¸ ê´€ë¦¬ì í˜ì´ì§€</a>
        <h1>GrapeSEED Brochure Request</h1>
        <p class="subtitle">í•„ìš”í•œ ë¸Œë¡œì…”ë¥¼ ì‹ ì²­í•˜ì„¸ìš”. ì‹ ì²­í•˜ì‹  ë¸Œë¡œì…”ëŠ” ìµœëŒ€ 3ì¼ ì´ë‚´ì— ë°œì†¡ë©ë‹ˆë‹¤.</p>
        
        <div id="alert" class="alert"></div>

        <form id="brochureForm">
            <!-- ë¸Œë¡œì…” ì‹ ì²­ í–‰ë“¤ -->
            <div class="form-section">
                <h3>ë¸Œë¡œì…” ì‹ ì²­</h3>
                <div class="option-container">
                    <div class="option-item" style="margin-bottom: 10px;">
                        <label for="option-1">ë‹´ë‹¹ì ì´ë¦„</label>
                        <select id="option-1" name="option-1">
                            <!-- ë‹´ë‹¹ì ì˜µì…˜ì´ ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
                        </select>
                    </div>
                </div>
                <div id="rowsContainer">
                    <!-- í–‰ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
                <button type="button" class="btn btn-success btn-add-row" onclick="addRow()">+ ë‹¤ë¥¸ ê¸°ê´€ ì¶”ê°€</button>
            </div>

            <!-- ê° ê±´ë§ˆë‹¤ ê°œë³„ ì €ì¥ ë²„íŠ¼ì´ ìˆìœ¼ë¯€ë¡œ ì „ì²´ ì €ì¥ ë²„íŠ¼ì€ ì œê±° -->
        </form>
    </div>

    <script src="js/api.js"></script>
    <script>
        let rowCount = 0;

        // ë¸Œë¡œì…” ì˜µì…˜ ëª©ë¡ ë¡œë“œ (APIì—ì„œ)
        async function loadBrochureOptions() {
            try {
                const brochures = await BrochureAPI.getAll();
                return brochures.map(b => ({
                    value: b.id,
                    text: b.name
                }));
            } catch (error) {
                console.error('ë¸Œë¡œì…” ì˜µì…˜ ë¡œë“œ ì˜¤ë¥˜:', error);
                return [];
            }
        }

        // ë‹´ë‹¹ì ì˜µì…˜ ëª©ë¡ ë¡œë“œ (APIì—ì„œ)
        async function loadContactOptions() {
            try {
                const contacts = await ContactAPI.getAll();
                return contacts.map(c => ({
                    value: c.id,
                    text: c.name
                }));
            } catch (error) {
                console.error('ë‹´ë‹¹ì ì˜µì…˜ ë¡œë“œ ì˜¤ë¥˜:', error);
                return [];
            }
        }

        // ë¸Œë¡œì…” ì¬ê³  ì°¨ê° í•¨ìˆ˜
        async function deductBrochureStock(brochures, contactName, schoolname, date) {
            try {
                const brochureMaster = await BrochureAPI.getAll();
                const insufficientStock = [];
                const stockChanges = []; // ì¬ê³  ë³€ê²½ ë‚´ì—­ ì €ì¥

                // ì¬ê³  í™•ì¸
                for (const brochure of brochures) {
                    const masterItem = brochureMaster.find(b => b.id == brochure.brochure);
                    if (masterItem) {
                        const currentStock = masterItem.stock || 0;
                        const requestedQuantity = brochure.quantity || 0;
                        
                        if (currentStock < requestedQuantity) {
                            insufficientStock.push({
                                name: brochure.brochureName,
                                requested: requestedQuantity,
                                available: currentStock
                            });
                        } else {
                            // ì¬ê³  ë³€ê²½ ë‚´ì—­ ì €ì¥
                            stockChanges.push({
                                brochureId: brochure.brochure,
                                brochureName: brochure.brochureName,
                                quantity: requestedQuantity,
                                beforeStock: currentStock,
                                afterStock: currentStock - requestedQuantity
                            });
                        }
                    }
                }

                // ì¬ê³  ë¶€ì¡±ì´ ìˆìœ¼ë©´ false ë°˜í™˜
                if (insufficientStock.length > 0) {
                    return {
                        success: false,
                        insufficient: insufficientStock
                    };
                }

                // ì¬ê³  ì°¨ê° ë° ì¶œê³  ë‚´ì—­ ì €ì¥
                for (const change of stockChanges) {
                    // ì¬ê³  ì°¨ê° (ìŒìˆ˜ë¡œ ì „ë‹¬)
                    await BrochureAPI.updateStock(change.brochureId, -change.quantity, date || new Date().toISOString().split('T')[0]);
                    
                    // ì¶œê³  ë‚´ì—­ ì €ì¥
                    await StockHistoryAPI.create({
                        type: 'ì¶œê³ ',
                        date: date || new Date().toISOString().split('T')[0],
                        brochure_id: change.brochureId,
                        brochure_name: change.brochureName,
                        quantity: change.quantity,
                        contact_name: contactName || '',
                        schoolname: schoolname || '',
                        before_stock: change.beforeStock,
                        after_stock: change.afterStock
                    });
                }

                return { success: true };
            } catch (error) {
                console.error('ì¬ê³  ì°¨ê° ì˜¤ë¥˜:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        // í–‰ ì¶”ê°€ í•¨ìˆ˜
        async function addRow() {
            rowCount++;
            const rowsContainer = document.getElementById('rowsContainer');
            
            const rowDiv = document.createElement('div');
            rowDiv.className = 'row-container';
            rowDiv.id = `row-${rowCount}`;
            
            // ë¸Œë¡œì…” ì„ íƒ ì˜µì…˜ ìƒì„± (APIì—ì„œ ë¡œë“œ)
            const brochureOptions = await loadBrochureOptions();
            let brochureOptionsHtml = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            brochureOptions.forEach(option => {
                brochureOptionsHtml += `<option value="${option.value}">${option.text}</option>`;
            });

            rowDiv.innerHTML = `
                <div class="row-header">
                    <div class="form-group">
                        <label for="date-${rowCount}">ë‚ ì§œ</label>
                        <input type="date" id="date-${rowCount}" name="date-${rowCount}" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="schoolname-${rowCount}">ê¸°ê´€ëª…</label>
                        <input type="text" id="schoolname-${rowCount}" name="schoolname-${rowCount}" class="schoolname-input" placeholder="ê¸°ê´€ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                    </div>
                </div>
                <div class="row-fields">
                    <div class="form-group expand">
                        <label for="address-${rowCount}">ì£¼ì†Œ</label>
                        <input type="text" id="address-${rowCount}" name="address-${rowCount}" required>
                    </div>
                    <div class="form-group narrow">
                        <label for="phone-${rowCount}">ì „í™”ë²ˆí˜¸</label>
                        <input type="tel" id="phone-${rowCount}" name="phone-${rowCount}" placeholder="010-0000-0000" oninput="formatPhoneNumber(this)" maxlength="13" required>
                    </div>
                </div>

                <div class="row-fields full-width">
                    <div class="form-group">
                        <div class="brochure-container" id="brochure-container-${rowCount}">
                            <!-- ë¸Œë¡œì…” í•­ëª©ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </div>
                        <button type="button" class="btn btn-success btn-small brochure-add-btn" onclick="addBrochureItem(${rowCount})">+ ë¸Œë¡œì…” ì¶”ê°€</button>
                    </div>
                </div>
                
                <div class="row-fields full-width">
                    <div class="form-group">
                        <label>ì†¡ì¥ë²ˆí˜¸(í™”ì„± ë¬¼ë¥˜ì°½ê³  ì…ë ¥)</label>
                        <div class="invoice-container" id="invoice-container-${rowCount}">
                            <!-- ì†¡ì¥ë²ˆí˜¸ í•„ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </div>
                        <!-- ì†¡ì¥ë²ˆí˜¸ëŠ” logistics í˜ì´ì§€ì—ì„œë§Œ ì¶”ê°€ ê°€ëŠ¥ -->
                    </div>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                    <button type="button" class="btn btn-danger" onclick="removeRow(${rowCount})" style="padding: 10px 20px; font-size: 14px;">ì‚­ì œ</button>
                    <button type="button" class="btn btn-primary" onclick="saveSingleRequest(${rowCount})" style="padding: 10px 20px; font-size: 14px;">ì €ì¥</button>
                </div>
            `;
            
            rowsContainer.appendChild(rowDiv);
            // ê¸°ë³¸ ë¸Œë¡œì…” í•­ëª© í•˜ë‚˜ ì¶”ê°€
            addBrochureItem(rowCount, true).catch(err => console.error('ë¸Œë¡œì…” í•­ëª© ì¶”ê°€ ì˜¤ë¥˜:', err));
            // ì†¡ì¥ë²ˆí˜¸ í•„ë“œëŠ” ë¹„í™œì„±í™” (logistics í˜ì´ì§€ì—ì„œë§Œ ì¶”ê°€ ê°€ëŠ¥)
            addInvoiceField(rowCount, []);
            updateRowNumbers();
        }

        // í–‰ ì‚­ì œ í•¨ìˆ˜
        function removeRow(rowId) {
            const row = document.getElementById(`row-${rowId}`);
            if (row) {
                row.remove();
                updateRowNumbers();
            }
        }

        // í–‰ ë²ˆí˜¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ë” ì´ìƒ í•„ìš” ì—†ì§€ë§Œ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€)
        function updateRowNumbers() {
            // ê¸°ê´€ëª… ì…ë ¥ í•„ë“œë¡œ ë³€ê²½ë˜ì–´ ë” ì´ìƒ ë²ˆí˜¸ ì—…ë°ì´íŠ¸ ë¶ˆí•„ìš”
        }

        // ë¸Œë¡œì…” í•­ëª© ì¶”ê°€ í•¨ìˆ˜
        async function addBrochureItem(rowId, isDefault = false) {
            const container = document.getElementById(`brochure-container-${rowId}`);
            if (!container) return;

            const brochureCount = container.querySelectorAll('.brochure-item').length;
            const itemId = `brochure-${rowId}-${brochureCount + 1}`;
            
            try {
                // ë¸Œë¡œì…” ì„ íƒ ì˜µì…˜ ìƒì„± (APIì—ì„œ ë¡œë“œ)
                const brochureOptions = await loadBrochureOptions();
                let brochureOptionsHtml = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
                brochureOptions.forEach(option => {
                    brochureOptionsHtml += `<option value="${option.value}">${option.text}</option>`;
                });

                const brochureItem = document.createElement('div');
                brochureItem.className = 'brochure-item';
                brochureItem.id = `brochure-item-${itemId}`;
                
                brochureItem.innerHTML = `
                    <div class="brochure-item-fields">
                        <div class="form-group expand">
                            <label for="${itemId}">ë¸Œë¡œì…”</label>
                            <select id="${itemId}" name="${itemId}" required>
                                ${brochureOptionsHtml}
                            </select>
                        </div>
                        <div class="form-group narrow">
                            <label for="quantity-${itemId}">ìˆ˜ëŸ‰</label>
                            <input type="number" id="quantity-${itemId}" name="quantity-${itemId}" min="1" placeholder="ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                        </div>
                        ${!isDefault ? `<button type="button" class="btn btn-danger btn-small" onclick="removeBrochureItem('${itemId}')" style="align-self: flex-end; margin-bottom: 0;">ì‚­ì œ</button>` : ''}
                    </div>
                `;
                
                container.appendChild(brochureItem);
            } catch (error) {
                console.error('ë¸Œë¡œì…” í•­ëª© ì¶”ê°€ ì˜¤ë¥˜:', error);
                showAlert('ë¸Œë¡œì…” ì˜µì…˜ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
            }
        }

        // ë¸Œë¡œì…” í•­ëª© ì‚­ì œ í•¨ìˆ˜
        function removeBrochureItem(itemId) {
            const item = document.getElementById(`brochure-item-${itemId}`);
            if (item) {
                item.remove();
            }
        }

        // ë¸Œë¡œì…” í•­ëª©ë“¤ ìˆ˜ì§‘ í•¨ìˆ˜
        function collectBrochureItems(rowId) {
            const container = document.getElementById(`brochure-container-${rowId}`);
            if (!container) return [];

            const items = [];
            const brochureItems = container.querySelectorAll('.brochure-item');
            
            brochureItems.forEach(item => {
                const select = item.querySelector('select');
                const input = item.querySelector('input[type="number"]');
                
                if (select && input && select.value && input.value) {
                    items.push({
                        brochure: select.value,
                        brochureName: select.options[select.selectedIndex].text,
                        quantity: parseInt(input.value)
                    });
                }
            });
            
            return items;
        }

        // ì „í™”ë²ˆí˜¸ ìë™ í¬ë§·íŒ… í•¨ìˆ˜
        function formatPhoneNumber(input) {
            // ìˆ«ìë§Œ ì¶”ì¶œ
            let value = input.value.replace(/[^\d]/g, '');
            
            // ì „í™”ë²ˆí˜¸ í¬ë§·íŒ… (000-0000-0000)
            if (value.length <= 3) {
                input.value = value;
            } else if (value.length <= 7) {
                input.value = value.slice(0, 3) + '-' + value.slice(3);
            } else if (value.length <= 11) {
                input.value = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7);
            } else {
                // 11ìë¦¬ ì´ˆê³¼ ì‹œ 11ìë¦¬ê¹Œì§€ë§Œ
                input.value = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7, 11);
            }
        }

        // ì†¡ì¥ë²ˆí˜¸ í•„ë“œ ì¶”ê°€ í•¨ìˆ˜ (ì½ê¸° ì „ìš©ìœ¼ë¡œ í‘œì‹œ)
        function addInvoiceField(rowId, invoices = []) {
            const container = document.getElementById(`invoice-container-${rowId}`);
            if (!container) return;

            // ê¸°ì¡´ ë‚´ìš© ì œê±°
            container.innerHTML = '';

            if (invoices && invoices.length > 0) {
                invoices.forEach((invoice, index) => {
                    const invoiceGroup = document.createElement('div');
                    invoiceGroup.className = 'invoice-group';
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = invoice;
                    input.disabled = true;
                    input.style.backgroundColor = '#f5f5f5';
                    input.style.cursor = 'not-allowed';
                    
                    invoiceGroup.appendChild(input);
                    container.appendChild(invoiceGroup);
                });
            } else {
                // ì†¡ì¥ë²ˆí˜¸ê°€ ì—†ì„ ë•Œ í‘œì‹œ
                const emptyMsg = document.createElement('div');
                emptyMsg.textContent = 'ì†¡ì¥ë²ˆí˜¸ê°€ ì•„ì§ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
                emptyMsg.style.color = '#999';
                emptyMsg.style.fontStyle = 'italic';
                emptyMsg.style.padding = '8px';
                container.appendChild(emptyMsg);
            }
        }

        // ì €ì¥ëœ ì‹ ì²­ ë°ì´í„°ì—ì„œ ì†¡ì¥ë²ˆí˜¸ ë¡œë“œ
        function loadInvoiceNumbers(rowId) {
            // í•´ë‹¹ í–‰ì˜ ë°ì´í„°ì™€ ì¼ì¹˜í•˜ëŠ” ì‹ ì²­ ì°¾ê¸°
            const date = document.getElementById(`date-${rowId}`)?.value;
            const schoolname = document.getElementById(`schoolname-${rowId}`)?.value;
            const address = document.getElementById(`address-${rowId}`)?.value;
            const phone = document.getElementById(`phone-${rowId}`)?.value;

            if (!date || !schoolname || !address || !phone) {
                return;
            }

            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ëª¨ë“  ì‹ ì²­ ë‚´ì—­ ê°€ì ¸ì˜¤ê¸°
            const allRequests = JSON.parse(localStorage.getItem('brochure_requests') || '[]');
            
            // ì¼ì¹˜í•˜ëŠ” ì‹ ì²­ ì°¾ê¸° (ë‚ ì§œ, ê¸°ê´€ëª…, ì£¼ì†Œ, ì „í™”ë²ˆí˜¸ë¡œ ë§¤ì¹­)
            for (let requestGroup of allRequests) {
                for (let request of requestGroup.requests || []) {
                    if (request.date === date &&
                        request.schoolname === schoolname &&
                        request.address === address &&
                        request.phone === phone) {
                        // ì†¡ì¥ë²ˆí˜¸ í‘œì‹œ
                        if (request.invoices && request.invoices.length > 0) {
                            addInvoiceField(rowId, request.invoices);
                        }
                        return;
                    }
                }
            }
        }

        // ì†¡ì¥ë²ˆí˜¸ í•„ë“œë“¤ ìˆ˜ì§‘ í•¨ìˆ˜
        function collectInvoiceFields(rowId) {
            const container = document.getElementById(`invoice-container-${rowId}`);
            if (!container) return [];

            const invoices = [];
            const invoiceInputs = container.querySelectorAll('input[type="text"]');
            invoiceInputs.forEach(input => {
                if (input.value.trim()) {
                    invoices.push(input.value.trim());
                }
            });
            return invoices;
        }

        // ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
        function showAlert(message, type = 'success') {
            const alertDiv = document.getElementById('alert');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 3000);
        }

        // ê°œë³„ ê±´ ì €ì¥ í•¨ìˆ˜
        async function saveSingleRequest(rowId) {
            // ìƒë‹¨ì˜ ë‹´ë‹¹ì ì„ íƒ ê°’ ê°€ì ¸ì˜¤ê¸°
            const contactSelect = document.getElementById('option-1');
            const contact = contactSelect.value;
            const contactName = contactSelect.options[contactSelect.selectedIndex]?.text || '';
            
            if (!contact) {
                showAlert('ë‹´ë‹¹ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'danger');
                return;
            }

            // í•´ë‹¹ í–‰ì˜ ë°ì´í„° ìˆ˜ì§‘
            const date = document.getElementById(`date-${rowId}`)?.value;
            const schoolname = document.getElementById(`schoolname-${rowId}`)?.value;
            const address = document.getElementById(`address-${rowId}`)?.value;
            const phone = document.getElementById(`phone-${rowId}`)?.value;
            const brochures = collectBrochureItems(rowId);
            const invoices = collectInvoiceFields(rowId);
                
            // í•„ìˆ˜ í•„ë“œ ê²€ì¦
            if (!date || !schoolname || !address || !phone || brochures.length === 0) {
                showAlert('ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'danger');
                return;
            }

            try {
                // ì¬ê³  í™•ì¸ ë° ì°¨ê°
                const stockResult = await deductBrochureStock(brochures, contactName, schoolname, date);
                if (!stockResult.success) {
                    if (stockResult.insufficient) {
                        let message = 'ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤:\n';
                        stockResult.insufficient.forEach(item => {
                            message += `- ${item.name}: ìš”ì²­ ${item.requested}ê¶Œ, ë³´ìœ  ${item.available}ê¶Œ\n`;
                        });
                        alert(message);
                    } else {
                        showAlert('ì¬ê³  í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (stockResult.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'danger');
                    }
                    return;
                }

                // ë°ì´í„° ì €ì¥ (API ì‚¬ìš©)
                const requestData = {
                    date: date,
                    schoolname: schoolname,
                    address: address,
                    phone: phone,
                    contact_id: contact,
                    contact_name: contactName,
                    brochures: brochures.map(b => ({
                        brochure: b.brochure,
                        brochureName: b.brochureName,
                        quantity: b.quantity
                    })),
                    invoices: invoices.filter(inv => inv && inv.trim())
                };

                await RequestAPI.create(requestData);

                showAlert('ë¸Œë¡œì…” ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                
                // í•´ë‹¹ í–‰ ì œê±°
                const row = document.getElementById(`row-${rowId}`);
                if (row) {
                    row.remove();
                }
            } catch (error) {
                showAlert('ì‹ ì²­ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'danger');
            }
        }

        // í¼ ì œì¶œ ì²˜ë¦¬ - ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•Šì§€ë§Œ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€
        document.getElementById('brochureForm').addEventListener('submit', function(e) {
            e.preventDefault();
            showAlert('ê° ê±´ë§ˆë‹¤ ê°œë³„ ì €ì¥ ë²„íŠ¼ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.', 'danger');
        });

        // ë‹´ë‹¹ì ì˜µì…˜ ë¡œë“œ ë° í‘œì‹œ
        async function loadContactOptionsToSelect() {
            const contactSelect = document.getElementById('option-1');
            if (!contactSelect) return;

            try {
                const contacts = await loadContactOptions();
                contactSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
                contacts.forEach(contact => {
                    const option = document.createElement('option');
                    option.value = contact.value;
                    option.textContent = contact.text;
                    contactSelect.appendChild(option);
                });
            } catch (error) {
                console.error('ë‹´ë‹¹ì ì˜µì…˜ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ í–‰ í•˜ë‚˜ ì¶”ê°€ ë° ì˜µì…˜ ë¡œë“œ
        window.addEventListener('DOMContentLoaded', async function() {
            await loadContactOptionsToSelect();
            await addRow();
        });
    </script>
</body>
</html>