<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Request Brochure</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.5.0/dist/xlsx.full.min.js"></script>
    <script>
        // xlsx-js-styleì´ ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš° ëŒ€ì²´
        if (typeof XLSX === 'undefined') {
            document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"><\/script>');
        }
    </script>
    <script src="js/api.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'ë§‘ì€ ê³ ë”•', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #440b86;
            text-align: center;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .form-section h3 {
            margin-top: 0;
            color: #440b86;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group.expand {
            flex: 1;
        }

        .form-group.narrow {
            max-width: 300px;
            flex-shrink: 0;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .row-container {
            border: 2px solid #440b86;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: white;
            position: relative;
        }

        .row-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        .row-number {
            font-weight: bold;
            color: #440b86;
            font-size: 16px;
        }

        .schoolname-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            color: #440b86;
        }

        .schoolname-input::placeholder {
            color: #999;
            font-weight: normal;
        }

        .row-fields {
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }

        .row-fields.full-width {
            grid-template-columns: 1fr;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: #440b86;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0ca22c;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn-add-row {
            width: 100%;
            margin-top: 10px;
        }

        .invoice-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: flex-end;
            margin-bottom: 10px;
        }

        .invoice-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .invoice-group input {
            width: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
        }

        .invoice-group .btn {
            flex-shrink: 0;
        }

        .invoice-add-btn {
            margin-top: 0;
        }

        .btn-submit {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            margin-top: 20px;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 4px;
            display: none;
        }

        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
            }

            h1 {
                font-size: 24px;
            }

            .row-header {
                flex-direction: column;
                gap: 10px;
            }

            .row-fields {
                flex-direction: column;
                gap: 10px;
            }

            .form-group.narrow {
                max-width: 100%;
                width: 100%;
            }

            .form-group.expand {
                width: 100%;
            }

            .invoice-group {
                flex-direction: column;
                gap: 10px;
            }

            .invoice-group input {
                width: 100%;
            }

            .btn {
                width: 100%;
                margin-bottom: 5px;
            }

            .row-container {
                padding: 10px;
            }

            .pagination-container {
                flex-wrap: wrap;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }

            h1 {
                font-size: 20px;
            }

            .row-container {
                padding: 8px;
            }

            input, select {
                font-size: 16px; /* iOS ì¤Œ ë°©ì§€ */
            }
        }

        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 30px 0;
            gap: 10px;
        }

        .pagination {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
            gap: 5px;
        }

        .pagination li {
            display: inline-block;
        }

        .pagination a {
            display: block;
            padding: 8px 12px;
            text-decoration: none;
            color: #440b86;
            border: 1px solid #ddd;
            border-radius: 4px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .pagination a:hover {
            background-color: #440b86;
            color: white;
        }

        .pagination .active a {
            background-color: #440b86;
            color: white;
        }

        .pagination .disabled a {
            color: #ccc;
            pointer-events: none;
            cursor: not-allowed;
        }

        .pagination-info {
            color: #666;
            font-size: 14px;
            margin: 0 15px;
        }

        @media screen and (max-width: 768px) {
            .row-fields {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="requestbrochure-completed.html" class="nav-link" style="display: inline-block; margin-bottom: 20px; color: #440b86; text-decoration: none; font-weight: bold; transition: color 0.3s;">ğŸ“¦ ìš´ì†¡ì¥ ì…ë ¥ ì™„ë£Œ ë‚´ì—­</a>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <h1 style="margin: 0;">GrapeSEED Brochure Logistics</h1>
                <p class="subtitle" style="margin: 5px 0 0 0;">ì—‘ì…€ íŒŒì¼ì„ ë¨¼ì € ë‹¤ìš´ë¡œë“œ ë°›ì€ í›„ ì‹ ì²­ëœ ë¸Œë¡œì…”ì˜ ìš´ì†¡ì¥ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
            </div>
            <button type="button" class="btn btn-success" onclick="downloadExcel()" style="margin-left: 20px;">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
        </div>
        
        <div id="alert" class="alert"></div>

        <form id="brochureForm">
            <!-- ë¸Œë¡œì…” ì‹ ì²­ í–‰ë“¤ -->
            <div class="form-section">
                <h3>ì‹ ì²­ ë‚´ì—­ ë° ìš´ì†¡ì¥ ë²ˆí˜¸ ì…ë ¥</h3>
                <div id="rowsContainer">
                    <!-- ì €ì¥ëœ ì‹ ì²­ ë‚´ì—­ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
                <div class="pagination-container">
                    <div class="pagination-info" id="paginationInfo"></div>
                    <ul class="pagination" id="pagination">
                        <!-- í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </ul>
                </div>
            </div>

            <!-- ê° ê±´ë§ˆë‹¤ ê°œë³„ ì €ì¥ ë²„íŠ¼ì´ ìˆìœ¼ë¯€ë¡œ ì „ì²´ ì €ì¥ ë²„íŠ¼ì€ ì œê±° -->
        </form>
    </div>

    <script>
        let rowCount = 0;
        let currentPage = 1;
        const itemsPerPage = 10;
        let allPendingRequests = [];

        // ë¸Œë¡œì…” ì˜µì…˜ ëª©ë¡ ë¡œë“œ (APIì—ì„œ)
        async function loadBrochureOptions() {
            try {
                const brochures = await BrochureAPI.getAll();
                return brochures.map(b => ({
                    value: b.id,
                    text: b.name
                }));
            } catch (error) {
                console.error('ë¸Œë¡œì…” ì˜µì…˜ ë¡œë“œ ì˜¤ë¥˜:', error);
                return [];
            }
        }

        // ì €ì¥ëœ ì‹ ì²­ ë°ì´í„°ë¡œ í–‰ ì¶”ê°€ í•¨ìˆ˜
        async function addRowFromData(request, requestIndex, itemIndex, requestId) {
            rowCount++;
            const rowsContainer = document.getElementById('rowsContainer');
            
            const rowDiv = document.createElement('div');
            rowDiv.className = 'row-container';
            rowDiv.id = `row-${rowCount}`;
            rowDiv.dataset.requestIndex = requestIndex;
            rowDiv.dataset.itemIndex = itemIndex;
            rowDiv.dataset.requestId = requestId; // API ìš”ì²­ ID ì €ì¥
            
            try {
                // ë¸Œë¡œì…” ì„ íƒ ì˜µì…˜ ìƒì„± (APIì—ì„œ ë¡œë“œ)
                const brochureOptions = await loadBrochureOptions();
                let brochureOptionsHtml = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
                brochureOptions.forEach(option => {
                    const selected = option.value == request.brochure ? 'selected' : '';
                    brochureOptionsHtml += `<option value="${option.value}" ${selected}>${option.text}</option>`;
                });

            rowDiv.innerHTML = `
                <div class="row-header">
                    <div class="form-group">
                        <label for="date-${rowCount}">ë‚ ì§œ</label>
                        <input type="date" id="date-${rowCount}" name="date-${rowCount}" value="${request.date}" disabled style="background-color: #f5f5f5; cursor: not-allowed;">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="schoolname-${rowCount}">ê¸°ê´€ëª…</label>
                        <input type="text" id="schoolname-${rowCount}" name="schoolname-${rowCount}" class="schoolname-input" value="${request.schoolname}" disabled style="background-color: #f5f5f5; cursor: not-allowed;">
                    </div>
                    <div class="form-group narrow" style="display: flex; flex-direction: column; justify-content: flex-end;">
                        <div style="font-weight: bold; color: #333; margin-bottom: 5px; font-size: 12px; color: #666;">ë‹´ë‹¹ì</div>
                        <div style="color: #333; font-size: 14px;">${request.contactName || request.contact || '-'}</div>
                    </div>
                </div>
                <div class="row-fields">
                    <div class="form-group expand">
                        <label for="address-${rowCount}">ì£¼ì†Œ</label>
                        <input type="text" id="address-${rowCount}" name="address-${rowCount}" value="${request.address}" disabled style="background-color: #f5f5f5; cursor: not-allowed;">
                    </div>
                    <div class="form-group narrow">
                        <label for="phone-${rowCount}">ì „í™”ë²ˆí˜¸</label>
                        <input type="tel" id="phone-${rowCount}" name="phone-${rowCount}" value="${request.phone}" disabled style="background-color: #f5f5f5; cursor: not-allowed;">
                    </div>
                </div>
                <div class="row-fields full-width">
                    <div class="form-group">
                        <label>ë¸Œë¡œì…” ì‹ ì²­ ë‚´ì—­</label>
                        <div id="brochure-list-${rowCount}" style="padding: 10px; background-color: #f9f9f9; border-radius: 4px;">
                            ${request.brochures && request.brochures.length > 0 
                                ? request.brochures.map(b => `<div style="margin-bottom: 5px;">${b.brochureName} - ${b.quantity}ê¶Œ</div>`).join('')
                                : 'ë¸Œë¡œì…” ì •ë³´ ì—†ìŒ'}
                        </div>
                    </div>
                </div>
                <div class="row-fields full-width">
                    <div class="form-group">
                        <label>ìš´ì†¡ì¥ ë²ˆí˜¸</label>
                        <div class="invoice-container" id="invoice-container-${rowCount}">
                            <!-- ì†¡ì¥ë²ˆí˜¸ í•„ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </div>
                        <button type="button" class="btn btn-success btn-small invoice-add-btn" onclick="addInvoiceField(${rowCount})" style="margin-top: 10px;">+ ìš´ì†¡ì¥ ë²ˆí˜¸ ì¶”ê°€</button>
                    </div>
                </div>
                <div style="display: flex; justify-content: flex-end; margin-top: 15px;">
                    <button type="button" class="btn btn-primary" onclick="saveSingleInvoice(${rowCount}, ${requestIndex}, ${itemIndex})" style="padding: 10px 20px; font-size: 14px;">ì €ì¥</button>
                </div>
            `;
            
                rowsContainer.appendChild(rowDiv);
            } catch (error) {
                console.error('í–‰ ì¶”ê°€ ì˜¤ë¥˜:', error);
            }
            // ì €ì¥ëœ ì†¡ì¥ë²ˆí˜¸ê°€ ìˆìœ¼ë©´ í‘œì‹œ, ì—†ìœ¼ë©´ ê¸°ë³¸ í•„ë“œ í•˜ë‚˜ ì¶”ê°€
            if (request.invoices && request.invoices.length > 0) {
                request.invoices.forEach((invoice, index) => {
                    addInvoiceField(rowCount, index === 0);
                    const input = document.querySelector(`#invoice-container-${rowCount} input[type="text"]:last-of-type`);
                    if (input) {
                        input.value = invoice;
                    }
                });
            } else {
                addInvoiceField(rowCount, true);
            }
        }

        // í–‰ ì‚­ì œ í•¨ìˆ˜
        function removeRow(rowId) {
            const row = document.getElementById(`row-${rowId}`);
            if (row) {
                row.remove();
                updateRowNumbers();
            }
        }

        // í–‰ ë²ˆí˜¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ë” ì´ìƒ í•„ìš” ì—†ì§€ë§Œ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€)
        function updateRowNumbers() {
            // ê¸°ê´€ëª… ì…ë ¥ í•„ë“œë¡œ ë³€ê²½ë˜ì–´ ë” ì´ìƒ ë²ˆí˜¸ ì—…ë°ì´íŠ¸ ë¶ˆí•„ìš”
        }

        // ì „í™”ë²ˆí˜¸ ìë™ í¬ë§·íŒ… í•¨ìˆ˜
        function formatPhoneNumber(input) {
            // ìˆ«ìë§Œ ì¶”ì¶œ
            let value = input.value.replace(/[^\d]/g, '');
            
            // ì „í™”ë²ˆí˜¸ í¬ë§·íŒ… (000-0000-0000)
            if (value.length <= 3) {
                input.value = value;
            } else if (value.length <= 7) {
                input.value = value.slice(0, 3) + '-' + value.slice(3);
            } else if (value.length <= 11) {
                input.value = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7);
            } else {
                // 11ìë¦¬ ì´ˆê³¼ ì‹œ 11ìë¦¬ê¹Œì§€ë§Œ
                input.value = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7, 11);
            }
        }

        // ì†¡ì¥ë²ˆí˜¸ í•„ë“œ ì¶”ê°€ í•¨ìˆ˜
        function addInvoiceField(rowId, isDefault = false) {
            const container = document.getElementById(`invoice-container-${rowId}`);
            if (!container) return;

            const invoiceCount = container.querySelectorAll('.invoice-group').length;
            const invoiceId = `invoice-${rowId}-${invoiceCount + 1}`;
            
            const invoiceGroup = document.createElement('div');
            invoiceGroup.className = 'invoice-group';
            invoiceGroup.id = `invoice-group-${invoiceId}`;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.id = invoiceId;
            input.name = invoiceId;
            input.placeholder = 'ì†¡ì¥ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”';
            
            invoiceGroup.appendChild(input);
            
            // ê¸°ë³¸ í•„ë“œê°€ ì•„ë‹ˆë©´ ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
            if (!isDefault) {
                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.className = 'btn btn-danger btn-small';
                deleteBtn.textContent = 'ì‚­ì œ';
                deleteBtn.onclick = function() {
                    invoiceGroup.remove();
                };
                invoiceGroup.appendChild(deleteBtn);
            }
            
            container.appendChild(invoiceGroup);
        }

        // ì†¡ì¥ë²ˆí˜¸ í•„ë“œë“¤ ìˆ˜ì§‘ í•¨ìˆ˜
        function collectInvoiceFields(rowId) {
            const container = document.getElementById(`invoice-container-${rowId}`);
            if (!container) return [];

            const invoices = [];
            const invoiceInputs = container.querySelectorAll('input[type="text"]');
            invoiceInputs.forEach(input => {
                if (input.value.trim()) {
                    invoices.push(input.value.trim());
                }
            });
            return invoices;
        }

        // ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
        function showAlert(message, type = 'success') {
            const alertDiv = document.getElementById('alert');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 3000);
        }

        // ê°œë³„ ê±´ ì €ì¥ í•¨ìˆ˜
        async function saveSingleInvoice(rowId, requestIndex, itemIndex) {
            // ì†¡ì¥ë²ˆí˜¸ ìˆ˜ì§‘
            const invoices = collectInvoiceFields(rowId);
            
            // ë¹ˆ ì†¡ì¥ë²ˆí˜¸ í•„í„°ë§
            const validInvoices = invoices.filter(inv => inv && inv.trim() !== '');

            if (validInvoices.length === 0) {
                showAlert('ìš´ì†¡ì¥ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'danger');
                return;
            }

            try {
                // í–‰ì—ì„œ requestId ê°€ì ¸ì˜¤ê¸°
                const row = document.getElementById(`row-${rowId}`);
                const requestId = row?.dataset?.requestId;
                
                if (!requestId) {
                    showAlert('ìš”ì²­ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'danger');
                    return;
                }

                // APIë¥¼ í†µí•´ ìš´ì†¡ì¥ ë²ˆí˜¸ ì¶”ê°€
                await RequestAPI.addInvoices(requestId, validInvoices);

                showAlert('ìš´ì†¡ì¥ ë²ˆí˜¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            
                // í•´ë‹¹ í–‰ ì œê±° ë° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                setTimeout(() => {
                    loadSavedRequests();
                }, 500);
            } catch (error) {
                console.error('ìš´ì†¡ì¥ ë²ˆí˜¸ ì €ì¥ ì˜¤ë¥˜:', error);
                showAlert('ìš´ì†¡ì¥ ë²ˆí˜¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'danger');
            }
        }

        // í¼ ì œì¶œ ì²˜ë¦¬ - ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•Šì§€ë§Œ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€
        document.getElementById('brochureForm').addEventListener('submit', function(e) {
            e.preventDefault();
            showAlert('ê° ê±´ë§ˆë‹¤ ê°œë³„ ì €ì¥ ë²„íŠ¼ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.', 'danger');
        });

        // ì €ì¥ëœ ì‹ ì²­ ë‚´ì—­ ë¡œë“œ í•¨ìˆ˜ (ìš´ì†¡ì¥ ë²ˆí˜¸ê°€ ì…ë ¥ë˜ì§€ ì•Šì€ í•­ëª©ë§Œ í‘œì‹œ)
        async function loadSavedRequests() {
            try {
                const allRequests = await RequestAPI.getAll();
                const rowsContainer = document.getElementById('rowsContainer');
                rowsContainer.innerHTML = '';

                if (allRequests.length === 0) {
                    rowsContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">ì €ì¥ëœ ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    document.getElementById('pagination').innerHTML = '';
                    document.getElementById('paginationInfo').textContent = '';
                    return;
                }

                // ìš´ì†¡ì¥ ë²ˆí˜¸ê°€ ì…ë ¥ë˜ì§€ ì•Šì€ ì‹ ì²­ ë‚´ì—­ ìˆ˜ì§‘
                allPendingRequests = [];
                allRequests.forEach((req) => {
                    // ìš´ì†¡ì¥ ë²ˆí˜¸ê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆëŠ” ê²½ìš°ë§Œ ìˆ˜ì§‘
                    if (!req.invoices || req.invoices.length === 0 || 
                        req.invoices.every(inv => !inv || inv.trim() === '')) {
                        // API ì‘ë‹µì„ ê¸°ì¡´ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                        const request = {
                            date: req.date,
                            schoolname: req.schoolname,
                            address: req.address,
                            phone: req.phone,
                            contact: req.contact_id,
                            contactName: req.contact_name,
                            brochures: req.items || [],
                            invoices: req.invoices || []
                        };
                        allPendingRequests.push({
                            request: request,
                            requestId: req.id // API ìš”ì²­ ID ì €ì¥
                        });
                    }
                });

                if (allPendingRequests.length === 0) {
                    rowsContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">ìš´ì†¡ì¥ ë²ˆí˜¸ ì…ë ¥ì´ í•„ìš”í•œ ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    document.getElementById('pagination').innerHTML = '';
                    document.getElementById('paginationInfo').textContent = '';
                    return;
                }

                // í˜ì´ì§€ë„¤ì´ì…˜ ì ìš©
                currentPage = 1;
                displayPagedRequests();
            } catch (error) {
                console.error('ì‹ ì²­ ë‚´ì—­ ë¡œë“œ ì˜¤ë¥˜:', error);
                showAlert('ì‹ ì²­ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
            }
        }

        // í˜ì´ì§€ë„¤ì´ì…˜ ì ìš©ëœ ì‹ ì²­ ë‚´ì—­ í‘œì‹œ
        function displayPagedRequests() {
            const rowsContainer = document.getElementById('rowsContainer');
            rowsContainer.innerHTML = '';

            const totalItems = allPendingRequests.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageItems = allPendingRequests.slice(startIndex, endIndex);

            // í˜„ì¬ í˜ì´ì§€ì˜ í•­ëª©ë§Œ í‘œì‹œ
            pageItems.forEach(async item => {
                await addRowFromData(item.request, item.requestIndex || 0, item.itemIndex || 0, item.requestId);
            });

            // í˜ì´ì§€ë„¤ì´ì…˜ UI ì—…ë°ì´íŠ¸
            updatePagination(totalPages, totalItems);
        }

        // í˜ì´ì§€ë„¤ì´ì…˜ UI ì—…ë°ì´íŠ¸
        function updatePagination(totalPages, totalItems) {
            const pagination = document.getElementById('pagination');
            const paginationInfo = document.getElementById('paginationInfo');
            
            pagination.innerHTML = '';
            
            if (totalPages <= 1) {
                paginationInfo.textContent = `ì´ ${totalItems}ê°œ`;
                return;
            }

            // ì´ì „ ë²„íŠ¼
            const prevLi = document.createElement('li');
            prevLi.className = currentPage === 1 ? 'disabled' : '';
            prevLi.innerHTML = `<a onclick="goToPage(${currentPage - 1})">ì´ì „</a>`;
            pagination.appendChild(prevLi);

            // í˜ì´ì§€ ë²ˆí˜¸ë“¤
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                const firstLi = document.createElement('li');
                firstLi.innerHTML = `<a onclick="goToPage(1)">1</a>`;
                pagination.appendChild(firstLi);
                if (startPage > 2) {
                    const dotsLi = document.createElement('li');
                    dotsLi.className = 'disabled';
                    dotsLi.innerHTML = '<a>...</a>';
                    pagination.appendChild(dotsLi);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = i === currentPage ? 'active' : '';
                li.innerHTML = `<a onclick="goToPage(${i})">${i}</a>`;
                pagination.appendChild(li);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const dotsLi = document.createElement('li');
                    dotsLi.className = 'disabled';
                    dotsLi.innerHTML = '<a>...</a>';
                    pagination.appendChild(dotsLi);
                }
                const lastLi = document.createElement('li');
                lastLi.innerHTML = `<a onclick="goToPage(${totalPages})">${totalPages}</a>`;
                pagination.appendChild(lastLi);
            }

            // ë‹¤ìŒ ë²„íŠ¼
            const nextLi = document.createElement('li');
            nextLi.className = currentPage === totalPages ? 'disabled' : '';
            nextLi.innerHTML = `<a onclick="goToPage(${currentPage + 1})">ë‹¤ìŒ</a>`;
            pagination.appendChild(nextLi);

            // í˜ì´ì§€ ì •ë³´
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalItems);
            paginationInfo.textContent = `ì´ ${totalItems}ê°œ ì¤‘ ${startItem}-${endItem}ê°œ í‘œì‹œ`;
        }

        // í˜ì´ì§€ ì´ë™
        function goToPage(page) {
            const totalPages = Math.ceil(allPendingRequests.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            displayPagedRequests();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
        function downloadExcel() {
            if (allPendingRequests.length === 0) {
                showAlert('ë‹¤ìš´ë¡œë“œí•  ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.', 'danger');
                return;
            }

            // ì—‘ì…€ ë°ì´í„° ì¤€ë¹„
            const excelData = [];
            
            // í—¤ë” í–‰ (ì´ë¯¸ì§€ í˜•ì‹ì— ë§ê²Œ)
            excelData.push([
                'ë°°ì†¡ë©”ì„¸ì§€1',
                'ë°›ëŠ”ë¶„ì„±ëª…',
                'ë°›ëŠ”ë¶„ì „í™”ë²ˆí˜¸',
                'ë°›ëŠ”ë¶„ì£¼ì†Œ(ì „ì²´, ë¶„í• )',
                'ë‚´í’ˆì½”ë“œ',
                'ë‚´í’ˆëª…',
                'ë‚´í’ˆìˆ˜ëŸ‰',
                'ë°•ìŠ¤íƒ€ì…',
                'ìš´ì„êµ¬ë¶„',
                'ìš´ì†¡ì¥ë²ˆí˜¸',
                '' // Kì—´ (ë¹„ì–´ìˆìŒ)
            ]);

            // ë°ì´í„° í–‰ ì¶”ê°€
            allPendingRequests.forEach(item => {
                const request = item.request;
                
                // ë¸Œë¡œì…”ê°€ ì—¬ëŸ¬ ê°œì¸ ê²½ìš° ê°ê° ë³„ë„ í–‰ìœ¼ë¡œ ì¶”ê°€
                if (request.brochures && request.brochures.length > 0) {
                    request.brochures.forEach((brochure, index) => {
                        const row = [
                            'ë¸Œë¡œì…”', // ë°°ì†¡ë©”ì„¸ì§€1
                            request.schoolname || '', // ë°›ëŠ”ë¶„ì„±ëª…
                            request.phone || '', // ë°›ëŠ”ë¶„ì „í™”ë²ˆí˜¸
                            request.address || '', // ë°›ëŠ”ë¶„ì£¼ì†Œ(ì „ì²´, ë¶„í• )
                            'Brochure', // ë‚´í’ˆì½”ë“œ
                            brochure.brochureName || '', // ë‚´í’ˆëª…
                            brochure.quantity || '', // ë‚´í’ˆìˆ˜ëŸ‰
                            '', // ë°•ìŠ¤íƒ€ì… (ì—†ëŠ” ë°ì´í„°)
                            '', // ìš´ì„êµ¬ë¶„ (ì—†ëŠ” ë°ì´í„°)
                            request.invoices && request.invoices.length > 0 
                                ? request.invoices.join(', ') 
                                : '', // ìš´ì†¡ì¥ë²ˆí˜¸ (ë¯¸ì…ë ¥ ì‹œ ë¹ˆ í•­ëª©)
                            '' // Kì—´ (ë¹„ì–´ìˆìŒ)
                        ];
                        excelData.push(row);
                    });
                } else {
                    // ë¸Œë¡œì…” ì •ë³´ê°€ ì—†ëŠ” ê²½ìš°
                    excelData.push([
                        'ë¸Œë¡œì…”', // ë°°ì†¡ë©”ì„¸ì§€1
                        request.schoolname || '', // ë°›ëŠ”ë¶„ì„±ëª…
                        request.phone || '', // ë°›ëŠ”ë¶„ì „í™”ë²ˆí˜¸
                        request.address || '', // ë°›ëŠ”ë¶„ì£¼ì†Œ(ì „ì²´, ë¶„í• )
                        'Brochure', // ë‚´í’ˆì½”ë“œ
                        '', // ë‚´í’ˆëª…
                        '', // ë‚´í’ˆìˆ˜ëŸ‰
                        '', // ë°•ìŠ¤íƒ€ì…
                        '', // ìš´ì„êµ¬ë¶„
                        request.invoices && request.invoices.length > 0 
                            ? request.invoices.join(', ') 
                            : '', // ìš´ì†¡ì¥ë²ˆí˜¸
                        '' // Kì—´
                    ]);
                }
            });

            // ì›Œí¬ë¶ ìƒì„±
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(excelData);

            // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
            const colWidths = [
                { wch: 15 }, // ë°°ì†¡ë©”ì„¸ì§€1
                { wch: 15 }, // ë°›ëŠ”ë¶„ì„±ëª…
                { wch: 18 }, // ë°›ëŠ”ë¶„ì „í™”ë²ˆí˜¸
                { wch: 40 }, // ë°›ëŠ”ë¶„ì£¼ì†Œ(ì „ì²´, ë¶„í• )
                { wch: 12 }, // ë‚´í’ˆì½”ë“œ
                { wch: 30 }, // ë‚´í’ˆëª…
                { wch: 12 }, // ë‚´í’ˆìˆ˜ëŸ‰
                { wch: 12 }, // ë°•ìŠ¤íƒ€ì…
                { wch: 12 }, // ìš´ì„êµ¬ë¶„
                { wch: 20 }, // ìš´ì†¡ì¥ë²ˆí˜¸
                { wch: 10 }  // Kì—´
            ];
            ws['!cols'] = colWidths;

            // í—¤ë” ìŠ¤íƒ€ì¼ ì ìš©
            const headerStyle = {
                font: { 
                    bold: true,
                    sz: 11
                },
                fill: { 
                    fgColor: { rgb: "#D3D3D3" } // grey
                },
                alignment: {
                    horizontal: 'center',
                    vertical: 'center'
                }
            };
            
            const headerRange = XLSX.utils.decode_range(ws['!ref']);
            for (let col = headerRange.s.c; col <= headerRange.e.c; col++) {
                const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                if (!ws[cellAddress]) {
                    ws[cellAddress] = { t: 's', v: '' };
                }
                // í—¤ë” ìŠ¤íƒ€ì¼ ì ìš©
                ws[cellAddress].s = headerStyle;
            }

            // ì›Œí¬ì‹œíŠ¸ë¥¼ ì›Œí¬ë¶ì— ì¶”ê°€
            XLSX.utils.book_append_sheet(wb, ws, 'ì‹ ì²­ ë‚´ì—­');

            // íŒŒì¼ëª… ìƒì„± (í˜„ì¬ ë‚ ì§œ í¬í•¨)
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0].replace(/-/g, '');
            const fileName = `ë¸Œë¡œì…”_ì‹ ì²­ë‚´ì—­_${dateStr}.xlsx`;

            // ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            XLSX.writeFile(wb, fileName);
            
            showAlert('ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ì‹ ì²­ ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸°
        window.addEventListener('DOMContentLoaded', function() {
            loadSavedRequests();
        });
    </script>
</body>
</html>