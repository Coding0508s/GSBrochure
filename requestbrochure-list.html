<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹ ì²­ ë‚´ì—­ ì¡°íšŒ</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'ë§‘ì€ ê³ ë”•', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #440b86;
            text-align: center;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .search-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .search-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .search-group {
            flex: 1;
            min-width: 200px;
        }

        .search-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .search-group input,
        .search-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: #440b86;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0ca22c;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .request-card {
            border: 2px solid #440b86;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: white;
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #440b86;
        }

        .request-title {
            font-size: 18px;
            font-weight: bold;
            color: #440b86;
        }

        .request-date {
            color: #666;
            font-size: 14px;
        }

        .request-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            font-size: 12px;
            color: #666;
        }

        .info-value {
            color: #333;
            font-size: 14px;
        }

        .brochure-list {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }

        .brochure-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }

        .brochure-name {
            flex: 1;
            font-weight: bold;
        }

        .brochure-quantity {
            color: #440b86;
            font-weight: bold;
            margin-right: 20px;
        }

        .invoice-list {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .invoice-item {
            display: inline-block;
            padding: 5px 10px;
            margin: 5px 5px 5px 0;
            background-color: #e9ecef;
            border-radius: 4px;
            font-size: 12px;
        }

        .no-invoice {
            color: #999;
            font-style: italic;
            font-size: 12px;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-badge.completed {
            background-color: #28a745;
            color: white;
        }

        .status-badge.pending {
            background-color: #ffc107;
            color: #333;
        }

        .card-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .info-value input,
        .info-value select {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .brochure-item-edit {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 8px;
        }

        .brochure-item-edit input,
        .brochure-item-edit select {
            flex: 1;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .brochure-item-edit input[type="number"] {
            max-width: 100px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }

        .stat-item {
            flex: 1;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #440b86;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .nav-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #440b86;
            text-decoration: none;
            font-weight: bold;
        }

        .nav-link:hover {
            color: #0ca22c;
        }

        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 30px 0;
            gap: 10px;
        }

        .pagination {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
            gap: 5px;
        }

        .pagination li {
            display: inline-block;
        }

        .pagination a {
            display: block;
            padding: 8px 12px;
            text-decoration: none;
            color: #440b86;
            border: 1px solid #ddd;
            border-radius: 4px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .pagination a:hover {
            background-color: #440b86;
            color: white;
        }

        .pagination .active a {
            background-color: #440b86;
            color: white;
        }

        .pagination .disabled a {
            color: #ccc;
            pointer-events: none;
            cursor: not-allowed;
        }

        .pagination-info {
            color: #666;
            font-size: 14px;
            margin: 0 15px;
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
            }

            h1 {
                font-size: 24px;
            }

            .request-info {
                grid-template-columns: 1fr;
            }

            .request-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .search-row {
                flex-direction: column;
            }

            .search-group {
                min-width: 100%;
            }

            .request-card {
                padding: 15px;
            }

            .card-actions {
                flex-direction: column;
            }

            .card-actions .btn {
                width: 100%;
            }

            .pagination-container {
                flex-wrap: wrap;
            }

            .btn {
                width: 100%;
                margin-bottom: 5px;
            }
        }

        @media screen and (max-width: 480px) {
            .container {
                padding: 10px;
            }

            h1 {
                font-size: 20px;
            }

            .request-card {
                padding: 10px;
            }

            input, select {
                font-size: 16px; /* iOS ì¤Œ ë°©ì§€ */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="requestbrochure.html" class="nav-link">â† ì‹ ì²­ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</a>
        <h1>ì‹ ì²­ ë‚´ì—­ ì¡°íšŒ</h1>
        <p class="subtitle">ì‹ ì²­ ì™„ë£Œëœ ë¸Œë¡œì…” ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

        <div class="search-section">
            <div class="search-row">
                <div class="search-group">
                    <label>ë‚ ì§œ ê²€ìƒ‰</label>
                    <input type="date" id="searchDate" onchange="filterRequests()">
                </div>
                <div class="search-group">
                    <label>ê¸°ê´€ëª… ê²€ìƒ‰</label>
                    <input type="text" id="searchSchool" placeholder="ê¸°ê´€ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" onkeyup="filterRequests()">
                </div>
                <div class="search-group">
                    <label>ë°°ì†¡ ìƒíƒœ</label>
                    <select id="searchStatus" onchange="filterRequests()">
                        <option value="">ì „ì²´</option>
                        <option value="pending">ë°°ì†¡ ëŒ€ê¸°ì¤‘</option>
                        <option value="completed">ë°°ì†¡ì™„ë£Œ</option>
                    </select>
                </div>
                <div class="search-group">
                    <button class="btn btn-primary" onclick="filterRequests()">ê²€ìƒ‰</button>
                </div>
            </div>
        </div>

        <div class="stats" id="stats">
            <div class="stat-item">
                <div class="stat-number" id="totalRequests">0</div>
                <div class="stat-label">ì´ ì‹ ì²­ ê±´ìˆ˜</div>
            </div>
            <!-- <div class="stat-item">
                <div class="stat-number" id="totalBrochures">0</div>
                <div class="stat-label">ì´ ë¸Œë¡œì…” ìˆ˜ëŸ‰</div>
            </div> -->
            <div class="stat-item">
                <div class="stat-number" id="withInvoice">0</div>
                <div class="stat-label">ìš´ì†¡ì¥ ë“±ë¡ ì™„ë£Œ</div>
            </div>
        </div>

        <div id="requestsContainer">
            <!-- ì‹ ì²­ ë‚´ì—­ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>

        <div class="pagination-container">
            <div class="pagination-info" id="paginationInfo"></div>
            <ul class="pagination" id="pagination">
                <!-- í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </ul>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        let allRequests = [];
        let filteredRequests = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        // ë¸Œë¡œì…” ì˜µì…˜ ëª©ë¡ ë¡œë“œ (APIì—ì„œ)
        async function loadBrochureOptions() {
            try {
                const brochures = await BrochureAPI.getAll();
                return brochures.map(b => ({
                    value: b.id,
                    text: b.name
                }));
            } catch (error) {
                console.error('ë¸Œë¡œì…” ì˜µì…˜ ë¡œë“œ ì˜¤ë¥˜:', error);
                return [];
            }
        }

        // ë‹´ë‹¹ì ì˜µì…˜ ëª©ë¡ ë¡œë“œ (APIì—ì„œ)
        async function loadContactOptions() {
            try {
                const contacts = await ContactAPI.getAll();
                return contacts.map(c => ({
                    value: c.id,
                    text: c.name
                }));
            } catch (error) {
                console.error('ë‹´ë‹¹ì ì˜µì…˜ ë¡œë“œ ì˜¤ë¥˜:', error);
                return [];
            }
        }

        // ì €ì¥ëœ ì‹ ì²­ ë‚´ì—­ ë¡œë“œ
        async function loadRequests() {
            try {
                const requests = await RequestAPI.getAll();
                // API ì‘ë‹µì„ ê¸°ì¡´ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                allRequests = requests.map(req => ({
                    id: req.id, // APIì—ì„œ ë°›ì€ ID ì €ì¥
                    requests: [{
                        id: req.id, // ìš”ì²­ IDë„ ì €ì¥
                        date: req.date,
                        schoolname: req.schoolname,
                        address: req.address,
                        phone: req.phone,
                        contact: req.contact_id,
                        contactName: req.contact_name,
                        brochures: req.items || [],
                        invoices: req.invoices || []
                    }],
                    submittedAt: req.submitted_at
                }));
                filteredRequests = [...allRequests];
                currentPage = 1;
                displayRequests();
                updateStats();
            } catch (error) {
                console.error('ì‹ ì²­ ë‚´ì—­ ë¡œë“œ ì˜¤ë¥˜:', error);
                showAlert('ì‹ ì²­ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
            }
        }

        // ëª¨ë“  ì‹ ì²­ì„ í‰ë©´ ë°°ì—´ë¡œ ë³€í™˜
        function flattenRequests() {
            const flatList = [];
            filteredRequests.forEach((requestGroup, groupIndex) => {
                if (requestGroup.requests && requestGroup.requests.length > 0) {
                    requestGroup.requests.forEach((request, requestIndex) => {
                        flatList.push({
                            request: request,
                            groupIndex: groupIndex,
                            requestIndex: requestIndex
                        });
                    });
                }
            });
            return flatList;
        }

        // ì‹ ì²­ ë‚´ì—­ í‘œì‹œ
        function displayRequests() {
            const container = document.getElementById('requestsContainer');
            container.innerHTML = '';

            const flatList = flattenRequests();
            const totalItems = flatList.length;

            if (totalItems === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‹</div>
                        <p>ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                document.getElementById('pagination').innerHTML = '';
                document.getElementById('paginationInfo').textContent = '';
                return;
            }

            // í˜ì´ì§€ë„¤ì´ì…˜ ê³„ì‚°
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageItems = flatList.slice(startIndex, endIndex);

            // í˜„ì¬ í˜ì´ì§€ì˜ í•­ëª©ë§Œ í‘œì‹œ
            pageItems.forEach(item => {
                const requestCard = createRequestCard(item.request, item.groupIndex, item.requestIndex);
                container.appendChild(requestCard);
            });

            // í˜ì´ì§€ë„¤ì´ì…˜ UI ì—…ë°ì´íŠ¸
            updatePagination(totalPages, totalItems);
        }

        // í˜ì´ì§€ë„¤ì´ì…˜ UI ì—…ë°ì´íŠ¸
        function updatePagination(totalPages, totalItems) {
            const pagination = document.getElementById('pagination');
            const paginationInfo = document.getElementById('paginationInfo');
            
            pagination.innerHTML = '';
            
            if (totalPages <= 1) {
                paginationInfo.textContent = `ì´ ${totalItems}ê°œ`;
                return;
            }

            // ì´ì „ ë²„íŠ¼
            const prevLi = document.createElement('li');
            prevLi.className = currentPage === 1 ? 'disabled' : '';
            prevLi.innerHTML = `<a onclick="goToPage(${currentPage - 1})">ì´ì „</a>`;
            pagination.appendChild(prevLi);

            // í˜ì´ì§€ ë²ˆí˜¸ë“¤
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                const firstLi = document.createElement('li');
                firstLi.innerHTML = `<a onclick="goToPage(1)">1</a>`;
                pagination.appendChild(firstLi);
                if (startPage > 2) {
                    const dotsLi = document.createElement('li');
                    dotsLi.className = 'disabled';
                    dotsLi.innerHTML = '<a>...</a>';
                    pagination.appendChild(dotsLi);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = i === currentPage ? 'active' : '';
                li.innerHTML = `<a onclick="goToPage(${i})">${i}</a>`;
                pagination.appendChild(li);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const dotsLi = document.createElement('li');
                    dotsLi.className = 'disabled';
                    dotsLi.innerHTML = '<a>...</a>';
                    pagination.appendChild(dotsLi);
                }
                const lastLi = document.createElement('li');
                lastLi.innerHTML = `<a onclick="goToPage(${totalPages})">${totalPages}</a>`;
                pagination.appendChild(lastLi);
            }

            // ë‹¤ìŒ ë²„íŠ¼
            const nextLi = document.createElement('li');
            nextLi.className = currentPage === totalPages ? 'disabled' : '';
            nextLi.innerHTML = `<a onclick="goToPage(${currentPage + 1})">ë‹¤ìŒ</a>`;
            pagination.appendChild(nextLi);

            // í˜ì´ì§€ ì •ë³´
            const startItem = startIndex + 1;
            const endItem = Math.min(endIndex, totalItems);
            paginationInfo.textContent = `ì´ ${totalItems}ê°œ ì¤‘ ${startItem}-${endItem}ê°œ í‘œì‹œ`;
        }

        // í˜ì´ì§€ ì´ë™
        function goToPage(page) {
            const flatList = flattenRequests();
            const totalPages = Math.ceil(flatList.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            displayRequests();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ì‹ ì²­ ì¹´ë“œ ìƒì„±
        function createRequestCard(request, groupIndex, requestIndex) {
            const card = document.createElement('div');
            card.className = 'request-card';

            // ë¸Œë¡œì…” ëª©ë¡ ìƒì„±
            let brochureListHtml = '';
            if (request.brochures && request.brochures.length > 0) {
                request.brochures.forEach(brochure => {
                    brochureListHtml += `
                        <div class="brochure-item">
                            <span class="brochure-name">${brochure.brochureName}</span>
                            <span class="brochure-quantity">${brochure.quantity}ê¶Œ</span>
                        </div>
                    `;
                });
            }

            // ì†¡ì¥ë²ˆí˜¸ ëª©ë¡ ìƒì„±
            let invoiceListHtml = '';
            const hasInvoices = request.invoices && request.invoices.length > 0 && 
                               request.invoices.some(inv => inv && inv.trim() !== '');
            
            if (hasInvoices) {
                request.invoices.forEach(invoice => {
                    if (invoice && invoice.trim() !== '') {
                        invoiceListHtml += `<span class="invoice-item">${invoice}</span>`;
                    }
                });
            } else {
                invoiceListHtml = '<span class="no-invoice">ë°°ì†¡ ëŒ€ê¸°ì¤‘</span>';
            }

            // ë°°ì†¡ ìƒíƒœ ë°°ì§€
            const statusBadge = hasInvoices 
                ? '<span class="status-badge completed">ë°°ì†¡ì™„ë£Œ</span>'
                : '<span class="status-badge pending">ë°°ì†¡ ëŒ€ê¸°ì¤‘</span>';

            const cardId = `card-${groupIndex}-${requestIndex}`;
            const isEditable = !hasInvoices;
            
            card.id = cardId;
            card.dataset.groupIndex = groupIndex;
            card.dataset.requestIndex = requestIndex;
            
            // ìˆ˜ì • ë²„íŠ¼ (ë°°ì†¡ ì™„ë£Œê°€ ì•„ë‹Œ ê²½ìš°ë§Œ)
            const editButton = isEditable 
                ? `<div class="card-actions">
                    <button class="btn btn-primary" onclick="editRequest('${cardId}')">ìˆ˜ì •</button>
                   </div>`
                : '';

            card.innerHTML = `
                <div class="request-header">
                    <div>
                        <div class="request-title">${request.schoolname}</div>
                        <div class="request-date">ì‹ ì²­ì¼: ${formatDate(request.date)}</div>
                    </div>
                    ${statusBadge}
                </div>
                <div class="request-info">
                    <div class="info-item">
                        <div class="info-label">ê¸°ê´€ëª…</div>
                        <div class="info-value" data-field="schoolname">${request.schoolname}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ì£¼ì†Œ</div>
                        <div class="info-value" data-field="address">${request.address}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ì „í™”ë²ˆí˜¸</div>
                        <div class="info-value" data-field="phone">${request.phone}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ë‹´ë‹¹ì</div>
                        <div class="info-value" data-field="contactName">${request.contactName || request.contact || '-'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ì‹ ì²­ì¼</div>
                        <div class="info-value" data-field="date">${formatDate(request.date)}</div>
                    </div>
                </div>
                <div class="brochure-list" data-brochures="${encodeURIComponent(JSON.stringify(request.brochures || []))}">
                    <div class="info-label" style="margin-bottom: 10px;">ì‹ ì²­ ë¸Œë¡œì…”</div>
                    <div class="brochure-items-container">${brochureListHtml}</div>
                </div>
                <div class="invoice-list">
                    <div class="info-label" style="margin-bottom: 10px;">ìš´ì†¡ì¥ ë²ˆí˜¸</div>
                    ${invoiceListHtml}
                </div>
                ${editButton}
            `;

            return card;
        }

        // ìˆ˜ì • ëª¨ë“œë¡œ ì „í™˜
        async function editRequest(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;

            const groupIndex = parseInt(card.dataset.groupIndex);
            const requestIndex = parseInt(card.dataset.requestIndex);
            const request = filteredRequests[groupIndex]?.requests[requestIndex];
            if (!request) return;

            try {
                // í•„ë“œë“¤ì„ í¸ì§‘ ê°€ëŠ¥í•˜ê²Œ ë³€ê²½
                const infoValues = card.querySelectorAll('.info-value');
                for (const item of infoValues) {
                    const field = item.dataset.field;
                    const currentValue = item.textContent.trim();
                    
                    if (field === 'date') {
                        // ë‚ ì§œëŠ” input[type="date"]ë¡œ
                        const dateValue = request.date || '';
                        item.innerHTML = `<input type="date" value="${dateValue}" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">`;
                    } else if (field === 'contactName') {
                        // ë‹´ë‹¹ìëŠ” selectë¡œ (APIì—ì„œ ë¡œë“œ)
                        const contactOptions = await loadContactOptions();
                        let optionsHtml = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
                        contactOptions.forEach(opt => {
                            const selected = opt.value == request.contact ? 'selected' : '';
                            optionsHtml += `<option value="${opt.value}" ${selected}>${opt.text}</option>`;
                        });
                        item.innerHTML = `<select style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">${optionsHtml}</select>`;
                    } else {
                        // ë‚˜ë¨¸ì§€ëŠ” text inputìœ¼ë¡œ
                        item.innerHTML = `<input type="text" value="${currentValue}" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">`;
                    }
                }

                // ë¸Œë¡œì…” ëª©ë¡ì„ í¸ì§‘ ê°€ëŠ¥í•˜ê²Œ ë³€ê²½
                const brochureContainer = card.querySelector('.brochure-items-container');
                if (brochureContainer && request.brochures) {
                    const brochureOptions = await loadBrochureOptions();
                    let brochureEditHtml = '';
                    request.brochures.forEach((brochure, index) => {
                        let optionsHtml = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
                        brochureOptions.forEach(opt => {
                            const selected = opt.value == brochure.brochure ? 'selected' : '';
                            optionsHtml += `<option value="${opt.value}" ${selected}>${opt.text}</option>`;
                        });
                        brochureEditHtml += `
                            <div class="brochure-item-edit" data-index="${index}">
                                <select data-field="brochure" style="flex: 1; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">${optionsHtml}</select>
                                <input type="number" data-field="quantity" value="${brochure.quantity}" min="1" style="max-width: 100px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                <button type="button" class="btn btn-danger btn-small" onclick="removeBrochureItem(this)">ì‚­ì œ</button>
                            </div>
                        `;
                    });
                    brochureEditHtml += `<button type="button" class="btn btn-success btn-small" onclick="addBrochureItemEdit('${cardId}')" style="margin-top: 10px;">+ ë¸Œë¡œì…” ì¶”ê°€</button>`;
                    brochureContainer.innerHTML = brochureEditHtml;
                }
            } catch (error) {
                console.error('ìˆ˜ì • ëª¨ë“œ ì „í™˜ ì˜¤ë¥˜:', error);
                showAlert('ìˆ˜ì • ëª¨ë“œë¡œ ì „í™˜í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
            }

            // ìˆ˜ì •/ì·¨ì†Œ ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
            const actionsDiv = card.querySelector('.card-actions');
            if (actionsDiv) {
                actionsDiv.innerHTML = `
                    <button class="btn btn-primary" onclick="saveRequest('${cardId}')">ì €ì¥</button>
                    <button class="btn btn-secondary" onclick="cancelEdit('${cardId}')">ì·¨ì†Œ</button>
                `;
            }
        }

        // ë¸Œë¡œì…” í•­ëª© ì¶”ê°€ (ìˆ˜ì • ëª¨ë“œ)
        async function addBrochureItemEdit(cardId) {
            const card = document.getElementById(cardId);
            const container = card.querySelector('.brochure-items-container');
            if (!container) return;

            try {
                const brochureOptions = await loadBrochureOptions();
                let optionsHtml = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
                brochureOptions.forEach(opt => {
                    optionsHtml += `<option value="${opt.value}">${opt.text}</option>`;
                });

                const newItem = document.createElement('div');
                newItem.className = 'brochure-item-edit';
                newItem.innerHTML = `
                    <select data-field="brochure" style="flex: 1; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">${optionsHtml}</select>
                    <input type="number" data-field="quantity" value="1" min="1" style="max-width: 100px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    <button type="button" class="btn btn-danger btn-small" onclick="removeBrochureItem(this)">ì‚­ì œ</button>
                `;
                container.insertBefore(newItem, container.lastElementChild);
            } catch (error) {
                console.error('ë¸Œë¡œì…” ì˜µì…˜ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ë¸Œë¡œì…” í•­ëª© ì‚­ì œ
        function removeBrochureItem(button) {
            button.closest('.brochure-item-edit').remove();
        }

        // ìˆ˜ì • ì €ì¥
        async function saveRequest(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;

            const groupIndex = parseInt(card.dataset.groupIndex);
            const requestIndex = parseInt(card.dataset.requestIndex);
            
            // í•„ë“œ ê°’ ìˆ˜ì§‘
            const schoolname = card.querySelector('[data-field="schoolname"] input')?.value || '';
            const address = card.querySelector('[data-field="address"] input')?.value || '';
            const phone = card.querySelector('[data-field="phone"] input')?.value || '';
            const date = card.querySelector('[data-field="date"] input')?.value || '';
                    const contactSelect = card.querySelector('[data-field="contactName"] select');
                    const contact = contactSelect?.value || '';
                    const contactName = contactSelect?.options[contactSelect.selectedIndex]?.text || '';

            // ë¸Œë¡œì…” í•­ëª© ìˆ˜ì§‘
            const brochures = [];
            const brochureItems = card.querySelectorAll('.brochure-item-edit');
            brochureItems.forEach(item => {
                const brochureSelect = item.querySelector('[data-field="brochure"]');
                const quantityInput = item.querySelector('[data-field="quantity"]');
                if (brochureSelect && brochureSelect.value && quantityInput && quantityInput.value) {
                    brochures.push({
                        brochure: brochureSelect.value,
                        brochureName: brochureSelect.options[brochureSelect.selectedIndex].text,
                        quantity: parseInt(quantityInput.value)
                    });
                }
            });

            if (!schoolname || !address || !phone || !date || brochures.length === 0) {
                alert('ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // APIë¥¼ í†µí•´ ì—…ë°ì´íŠ¸
            try {
                // í˜„ì¬ ìš”ì²­ì˜ ID ì°¾ê¸°
                const flatList = flattenRequests();
                const currentItem = flatList.find(item => 
                    item.groupIndex === groupIndex && item.requestIndex === requestIndex
                );
                
                if (!currentItem) {
                    alert('ì‹ ì²­ ë‚´ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // APIì—ì„œ ìš”ì²­ ID ê°€ì ¸ì˜¤ê¸°
                const requestId = allRequests[groupIndex]?.id || allRequests[groupIndex]?.requests?.[requestIndex]?.id;
                
                if (!requestId) {
                    alert('ìš”ì²­ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                await RequestAPI.update(requestId, {
                    date: date,
                    schoolname: schoolname,
                    address: address,
                    phone: phone,
                    contact_id: contact,
                    contact_name: contactName,
                    brochures: brochures.map(b => ({
                        brochure: b.brochure,
                        brochureName: b.brochureName,
                        quantity: b.quantity
                    }))
                });
                
                await loadRequests();
                showAlert('ì‹ ì²­ ë‚´ì—­ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (error) {
                console.error('ìˆ˜ì • ì˜¤ë¥˜:', error);
                alert('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ìˆ˜ì • ì·¨ì†Œ
        function cancelEdit(cardId) {
            loadRequests();
        }

        // ë‚ ì§œ í¬ë§·íŒ…
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // í•„í„°ë§
        function filterRequests() {
            const schoolSearch = document.getElementById('searchSchool').value.toLowerCase();
            const dateSearch = document.getElementById('searchDate').value;
            const statusSearch = document.getElementById('searchStatus').value;

            filteredRequests = allRequests.map(requestGroup => {
                const filtered = requestGroup.requests.filter(request => {
                    const matchSchool = !schoolSearch || request.schoolname.toLowerCase().includes(schoolSearch);
                    const matchDate = !dateSearch || request.date === dateSearch;
                    
                    // ë°°ì†¡ ìƒíƒœ í•„í„°ë§
                    const hasInvoices = request.invoices && request.invoices.length > 0 && 
                                       request.invoices.some(inv => inv && inv.trim() !== '');
                    let matchStatus = true;
                    if (statusSearch === 'completed') {
                        matchStatus = hasInvoices;
                    } else if (statusSearch === 'pending') {
                        matchStatus = !hasInvoices;
                    }

                    return matchSchool && matchDate && matchStatus;
                });

                return {
                    ...requestGroup,
                    requests: filtered
                };
            }).filter(group => group.requests.length > 0);

            currentPage = 1;
            displayRequests();
            updateStats();
        }

        // í•„í„° ì´ˆê¸°í™”
        function clearFilters() {
            document.getElementById('searchSchool').value = '';
            document.getElementById('searchDate').value = '';
            document.getElementById('searchStatus').value = '';
            filteredRequests = [...allRequests];
            currentPage = 1;
            displayRequests();
            updateStats();
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            let totalRequests = 0;
            let totalBrochures = 0;
            let withInvoice = 0;

            filteredRequests.forEach(requestGroup => {
                if (requestGroup.requests) {
                    requestGroup.requests.forEach(request => {
                        totalRequests++;
                        if (request.brochures) {
                            request.brochures.forEach(b => {
                                totalBrochures += parseInt(b.quantity) || 0;
                            });
                        }
                        if (request.invoices && request.invoices.length > 0) {
                            withInvoice++;
                        }
                    });
                }
            });

            // ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•œ í›„ì—ë§Œ ì—…ë°ì´íŠ¸
            const totalRequestsEl = document.getElementById('totalRequests');
            const totalBrochuresEl = document.getElementById('totalBrochures');
            const withInvoiceEl = document.getElementById('withInvoice');

            if (totalRequestsEl) {
                totalRequestsEl.textContent = totalRequests;
            }
            if (totalBrochuresEl) {
                totalBrochuresEl.textContent = totalBrochures;
            }
            if (withInvoiceEl) {
                withInvoiceEl.textContent = withInvoice;
            }
        }

        // ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
        function showAlert(message, type = 'success') {
            // ê°„ë‹¨í•œ alertë¡œ ëŒ€ì²´ (ë˜ëŠ” ì»¤ìŠ¤í…€ ì•Œë¦¼ UI êµ¬í˜„ ê°€ëŠ¥)
            if (type === 'danger' || type === 'error') {
                alert('ì˜¤ë¥˜: ' + message);
            } else {
                alert(message);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        window.addEventListener('DOMContentLoaded', function() {
            loadRequests();
        });
    </script>
</body>
</html>

